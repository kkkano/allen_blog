<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLM ä½¿ç”¨æŠ€å·§ - åŸºäº Transformer åŸç†çš„äº¤äº’å¼å¯è§†åŒ–</title>
<style>
:root {
  --bg: #0f172a;
  --surface: #1e293b;
  --card: rgba(30, 41, 59, 0.7);
  --border: #334155;
  --text: #e2e8f0;
  --text-dim: #94a3b8;
  --primary: #38bdf8;
  --accent: #22c55e;
  --purple: #8b5cf6;
  --warning: #f59e0b;
  --danger: #ef4444;
}

*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: radial-gradient(circle at 20% 20%, #162542 0%, #0f172a 45%);
  color: var(--text);
  font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
  min-height: 100vh;
  line-height: 1.6;
  overflow-x: hidden;
}

.container {
  max-width: 960px;
  margin: 0 auto;
  padding: 32px 20px 48px;
}

h1 {
  text-align: center;
  font-size: 2rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
}

.subtitle {
  text-align: center;
  color: var(--text-dim);
  font-size: 0.95rem;
  margin-bottom: 32px;
}

/* Tab Navigation */
.tab-nav {
  display: flex;
  gap: 4px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 6px;
  margin-bottom: 24px;
  overflow-x: auto;
}

.tab-btn {
  flex: 1;
  min-width: 0;
  padding: 12px 8px;
  border: none;
  border-radius: 12px;
  background: transparent;
  color: var(--text-dim);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
  font-family: inherit;
}

.tab-btn:hover {
  color: var(--text);
  background: rgba(56, 189, 248, 0.08);
}

.tab-btn.active {
  background: linear-gradient(135deg, rgba(56, 189, 248, 0.15), rgba(139, 92, 246, 0.15));
  color: var(--primary);
  box-shadow: 0 2px 12px rgba(56, 189, 248, 0.15);
  border: 1px solid rgba(56, 189, 248, 0.25);
}

.tab-icon {
  font-size: 1.3rem;
}

.tab-label {
  font-size: 0.75rem;
}

/* Panels */
.panel {
  display: none;
  animation: fadeIn 0.4s ease;
}

.panel.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Card */
.card {
  background: var(--card);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.15rem;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text);
}

.section-title .icon {
  font-size: 1.2rem;
}

.description {
  color: var(--text-dim);
  font-size: 0.9rem;
  margin-bottom: 16px;
  line-height: 1.7;
}

/* Tip Box */
.tip-box {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(56, 189, 248, 0.08));
  border: 1px solid rgba(34, 197, 94, 0.25);
  border-radius: 12px;
  padding: 16px 20px;
  margin-top: 16px;
  font-size: 0.9rem;
  color: var(--accent);
  line-height: 1.7;
}

.tip-box::before {
  content: "ğŸ’¡ å®ç”¨å»ºè®®ï¼š";
  font-weight: 600;
  display: block;
  margin-bottom: 4px;
}

.warning-box {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(239, 68, 68, 0.06));
  border: 1px solid rgba(245, 158, 11, 0.25);
  border-radius: 12px;
  padding: 16px 20px;
  margin-top: 12px;
  font-size: 0.9rem;
  color: var(--warning);
  line-height: 1.7;
}

/* Slider */
.slider-group {
  margin: 20px 0;
}

.slider-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 0.9rem;
  color: var(--text-dim);
}

.slider-value {
  color: var(--primary);
  font-weight: 600;
  font-family: "Cascadia Code", "Fira Code", monospace;
}

input[type="range"] {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--border);
  border-radius: 3px;
  outline: none;
  cursor: pointer;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--primary);
  box-shadow: 0 0 10px rgba(56, 189, 248, 0.4);
  cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--primary);
  box-shadow: 0 0 10px rgba(56, 189, 248, 0.4);
  cursor: pointer;
  border: none;
}

/* Canvas */
canvas {
  display: block;
  width: 100%;
  border-radius: 12px;
  background: rgba(15, 23, 42, 0.5);
  border: 1px solid var(--border);
}

/* Formula */
.formula {
  text-align: center;
  padding: 16px;
  margin: 16px 0;
  background: rgba(139, 92, 246, 0.08);
  border: 1px solid rgba(139, 92, 246, 0.2);
  border-radius: 12px;
  font-family: "Cascadia Code", "Fira Code", monospace;
  font-size: 1.05rem;
  color: var(--purple);
  letter-spacing: 0.5px;
}

/* Token row */
.token-row {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  margin: 12px 0;
  align-items: flex-end;
}

.token-cell {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  transition: all 0.3s ease;
}

.token-bar {
  width: 100%;
  min-width: 28px;
  border-radius: 4px 4px 0 0;
  transition: height 0.5s ease, background 0.3s ease;
}

.token-text {
  font-size: 0.65rem;
  color: var(--text-dim);
  writing-mode: vertical-rl;
  text-orientation: mixed;
  max-height: 60px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.token-weight {
  font-size: 0.6rem;
  color: var(--primary);
  font-family: "Cascadia Code", "Fira Code", monospace;
}

/* Demo 4 specific */
.cot-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin: 16px 0;
}

@media (max-width: 640px) {
  .cot-comparison {
    grid-template-columns: 1fr;
  }
}

.cot-panel {
  background: rgba(15, 23, 42, 0.5);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  position: relative;
}

.cot-panel h4 {
  font-size: 0.9rem;
  margin-bottom: 12px;
  color: var(--text-dim);
}

.cot-panel.good {
  border-color: rgba(34, 197, 94, 0.3);
}

.cot-panel.bad {
  border-color: rgba(239, 68, 68, 0.3);
}

.cot-node {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 0.8rem;
  font-weight: 500;
  margin: 4px;
  transition: all 0.4s ease;
  position: relative;
}

.cot-node.question {
  background: rgba(56, 189, 248, 0.15);
  border: 1px solid rgba(56, 189, 248, 0.4);
  color: var(--primary);
}

.cot-node.step {
  background: rgba(139, 92, 246, 0.15);
  border: 1px solid rgba(139, 92, 246, 0.4);
  color: var(--purple);
}

.cot-node.answer {
  background: rgba(34, 197, 94, 0.15);
  border: 1px solid rgba(34, 197, 94, 0.4);
  color: var(--accent);
}

.cot-node.active {
  box-shadow: 0 0 16px rgba(56, 189, 248, 0.4);
  transform: scale(1.08);
}

.cot-arrow {
  color: var(--text-dim);
  font-size: 1.2rem;
  display: inline-flex;
  align-items: center;
  margin: 0 2px;
  opacity: 0.4;
  transition: all 0.4s ease;
}

.cot-arrow.active {
  opacity: 1;
  color: var(--primary);
}

.cot-flow {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  margin: 8px 0 16px;
  min-height: 50px;
}

.btn-group {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.btn {
  padding: 8px 20px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: rgba(56, 189, 248, 0.1);
  color: var(--primary);
  cursor: pointer;
  font-size: 0.85rem;
  font-family: inherit;
  transition: all 0.2s ease;
}

.btn:hover {
  background: rgba(56, 189, 248, 0.2);
  border-color: var(--primary);
}

.btn.active {
  background: rgba(56, 189, 248, 0.25);
  border-color: var(--primary);
  box-shadow: 0 0 10px rgba(56, 189, 248, 0.2);
}

/* Attention line canvas */
.attn-canvas-wrap {
  position: relative;
  margin: 16px 0;
}

/* Heatmap */
.heatmap-grid {
  display: grid;
  gap: 2px;
  margin: 16px 0;
}

.heatmap-cell {
  aspect-ratio: 1;
  border-radius: 3px;
  transition: background 0.5s ease;
  position: relative;
}

.heatmap-cell:hover::after {
  content: attr(data-val);
  position: absolute;
  top: -28px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--surface);
  color: var(--primary);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
  border: 1px solid var(--border);
  z-index: 10;
  pointer-events: none;
  font-family: monospace;
}

/* Legend */
.legend {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 12px 0;
  font-size: 0.8rem;
  color: var(--text-dim);
}

.legend-bar {
  width: 120px;
  height: 12px;
  border-radius: 3px;
}

/* Distribution bars */
.dist-bar-container {
  margin: 16px 0;
}

.dist-bar-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.dist-bar-label {
  width: 70px;
  font-size: 0.8rem;
  color: var(--text-dim);
  text-align: right;
  flex-shrink: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.dist-bar-track {
  flex: 1;
  height: 24px;
  background: rgba(15, 23, 42, 0.5);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}

.dist-bar-fill {
  height: 100%;
  border-radius: 6px;
  transition: width 0.4s ease, background 0.3s ease;
  display: flex;
  align-items: center;
  padding-left: 8px;
  font-size: 0.7rem;
  color: white;
  font-family: "Cascadia Code", "Fira Code", monospace;
  min-width: 0;
  white-space: nowrap;
}

/* Temperature indicator */
.temp-indicator {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 8px 0;
  padding: 12px 16px;
  background: rgba(15, 23, 42, 0.5);
  border-radius: 10px;
  border: 1px solid var(--border);
}

.temp-label {
  font-size: 0.85rem;
  font-weight: 600;
}

.temp-desc {
  font-size: 0.8rem;
  color: var(--text-dim);
}

/* Animation for CoT */
@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 6px rgba(56, 189, 248, 0.2); }
  50% { box-shadow: 0 0 20px rgba(56, 189, 248, 0.5); }
}

.glow-pulse {
  animation: pulseGlow 1.5s ease-in-out infinite;
}

/* Responsive */
@media (max-width: 640px) {
  h1 { font-size: 1.5rem; }
  .tab-btn { padding: 10px 4px; }
  .tab-label { font-size: 0.65rem; }
  .card { padding: 16px; }
  .formula { font-size: 0.85rem; }
}
</style>
</head>
<body>

<div class="container">
  <h1>LLM ä½¿ç”¨æŠ€å·§</h1>
  <p class="subtitle">åŸºäº Transformer æ¶æ„åŸç†çš„äº¤äº’å¼è§£è¯»</p>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-btn active" data-tab="tab1" onclick="switchTab('tab1')">
      <span class="tab-icon">ğŸ“</span>
      <span class="tab-label">é¦–å°¾è®°å¿†æ•ˆåº”</span>
    </button>
    <button class="tab-btn" data-tab="tab2" onclick="switchTab('tab2')">
      <span class="tab-icon">ğŸŒ¡ï¸</span>
      <span class="tab-label">æ¸©åº¦å‚æ•°</span>
    </button>
    <button class="tab-btn" data-tab="tab3" onclick="switchTab('tab3')">
      <span class="tab-icon">ğŸ”</span>
      <span class="tab-label">æ³¨æ„åŠ›ç¨€é‡Š</span>
    </button>
    <button class="tab-btn" data-tab="tab4" onclick="switchTab('tab4')">
      <span class="tab-icon">ğŸ”—</span>
      <span class="tab-label">CoT åŸç†</span>
    </button>
  </div>

  <!-- ============================================ -->
  <!-- Demo 1: Primacy-Recency Effect              -->
  <!-- ============================================ -->
  <div id="tab1" class="panel active">
    <div class="card">
      <div class="section-title">
        <span class="icon">ğŸ“</span>
        é¦–å°¾è®°å¿†æ•ˆåº” (Primacy-Recency Effect)
      </div>
      <p class="description">
        åœ¨å› æœæ³¨æ„åŠ›ï¼ˆCausal Attentionï¼‰ä¸­ï¼Œæœ€åä¸€ä¸ª token è´Ÿè´£"æ±‡æ€»"å‰æ–‡æ‰€æœ‰ä¿¡æ¯æ¥ç”Ÿæˆä¸‹ä¸€ä¸ªè¯ã€‚
        ç„¶è€Œï¼Œæ³¨æ„åŠ›å¹¶éå‡åŒ€åˆ†å¸ƒâ€”â€”å¼€å¤´å’Œç»“å°¾çš„å†…å®¹å¾€å¾€è·å¾—æ›´é«˜çš„æ³¨æ„åŠ›æƒé‡ï¼Œå½¢æˆç»å…¸çš„ <strong>U å½¢æ›²çº¿</strong>ã€‚
        ä¸­é—´çš„å†…å®¹å®¹æ˜“è¢«"ç¨€é‡Š"è€Œè¢«æ¨¡å‹å¿½ç•¥ã€‚
      </p>

      <div class="slider-group">
        <div class="slider-label">
          <span>ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆå¥å­æ•°é‡ï¼‰</span>
          <span class="slider-value" id="primacy-len-val">12</span>
        </div>
        <input type="range" id="primacy-len" min="6" max="30" value="12" step="1" oninput="updatePrimacy()">
      </div>

      <div class="slider-group">
        <div class="slider-label">
          <span>é¦–å°¾æ•ˆåº”å¼ºåº¦</span>
          <span class="slider-value" id="primacy-strength-val">0.70</span>
        </div>
        <input type="range" id="primacy-strength" min="30" max="95" value="70" step="1" oninput="updatePrimacy()">
      </div>

      <canvas id="primacy-canvas" height="320"></canvas>

      <div class="formula">
        Attention(last) = softmax(q_last &middot; K<sup>T</sup> / &radic;d_k) &middot; V
      </div>

      <p class="description" style="margin-top:12px;">
        ä¸Šå›¾å±•ç¤ºäº†<strong>æœ€åä¸€ä¸ª token</strong> å¯¹å‰æ–‡æ¯ä¸ªä½ç½®çš„æ³¨æ„åŠ›æƒé‡åˆ†å¸ƒã€‚
        å¯ä»¥çœ‹åˆ°ä¸¤ç«¯ï¼ˆå¼€å¤´ & ç»“å°¾ï¼‰çš„æƒé‡æ˜æ˜¾æ›´é«˜ï¼Œä¸­é—´éƒ¨åˆ†ç›¸å¯¹è¾ƒä½ã€‚
        æ‹–åŠ¨æ»‘å—å¢åŠ ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œè§‚å¯Ÿä¸­é—´éƒ¨åˆ†çš„æ³¨æ„åŠ›å¦‚ä½•è¿›ä¸€æ­¥è¢«ç¨€é‡Šã€‚
      </p>

      <div class="tip-box">
        æŠŠæœ€é‡è¦çš„æŒ‡ä»¤æ”¾åœ¨æç¤ºè¯çš„<strong>å¼€å¤´</strong>æˆ–<strong>ç»“å°¾</strong>ï¼ä¸­é—´ä½ç½®çš„å†…å®¹æœ€å®¹æ˜“è¢«æ¨¡å‹å¿½ç•¥ã€‚
        è¿™å¯¹é•¿æç¤ºè¯å°¤å…¶é‡è¦â€”â€”å¦‚æœä½ æœ‰ä¸€ä¸ªå…³é”®çº¦æŸï¼Œå®å¯é‡å¤å†™åœ¨å¼€å¤´å’Œç»“å°¾å„ä¸€æ¬¡ã€‚
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- Demo 2: Temperature Scaling                  -->
  <!-- ============================================ -->
  <div id="tab2" class="panel">
    <div class="card">
      <div class="section-title">
        <span class="icon">ğŸŒ¡ï¸</span>
        æ¸©åº¦å‚æ•° (Temperature Scaling)
      </div>
      <p class="description">
        Transformer åœ¨ç”Ÿæˆä¸‹ä¸€ä¸ªè¯æ—¶ï¼Œä¼šå¯¹æ‰€æœ‰å€™é€‰è¯è®¡ç®— logitsï¼ˆåŸå§‹åˆ†æ•°ï¼‰ï¼Œç„¶åé€šè¿‡ softmax å‡½æ•°è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒã€‚
        <strong>æ¸©åº¦å‚æ•° T</strong> æ§åˆ¶è¿™ä¸ªæ¦‚ç‡åˆ†å¸ƒçš„"å°–é”"ç¨‹åº¦ã€‚æ¸©åº¦è¶Šä½åˆ†å¸ƒè¶Šé›†ä¸­ï¼Œæ¸©åº¦è¶Šé«˜åˆ†å¸ƒè¶Šå¹³å¦ã€‚
      </p>

      <div class="formula">
        P(word_i) = exp(logit_i / T) / &Sigma; exp(logit_j / T)
      </div>

      <div class="slider-group">
        <div class="slider-label">
          <span>æ¸©åº¦ T</span>
          <span class="slider-value" id="temp-val">1.00</span>
        </div>
        <input type="range" id="temp-slider" min="5" max="200" value="100" step="1" oninput="updateTemperature()">
      </div>

      <div class="temp-indicator" id="temp-indicator">
        <div>
          <div class="temp-label" id="temp-mode">é»˜è®¤è®¾ç½®</div>
          <div class="temp-desc" id="temp-desc">å¹³è¡¡çš„è¾“å‡ºåˆ†å¸ƒ</div>
        </div>
        <div style="font-size:1.5rem;" id="temp-emoji">âš–ï¸</div>
      </div>

      <div id="temp-bars" class="dist-bar-container"></div>

      <canvas id="temp-canvas" height="260"></canvas>

      <div class="tip-box">
        <strong>å†™ä»£ç </strong>æ—¶ç”¨ä½æ¸©åº¦ (0.1-0.3)ï¼Œç¡®ä¿è¾“å‡ºç¡®å®šæ€§é«˜ã€é€»è¾‘ä¸¥è°¨ã€‚<br>
        <strong>å†™åˆ›æ„æ–‡ç« </strong>æ—¶ç”¨ä¸­é«˜æ¸©åº¦ (0.7-1.0)ï¼Œè®©æ¨¡å‹è¾“å‡ºæ›´å¤šæ ·åŒ–ã€‚<br>
        <strong>å¤´è„‘é£æš´</strong>æ—¶å¯å°è¯•é«˜æ¸©åº¦ (1.2-1.5)ï¼Œä½†æ³¨æ„è¿è´¯æ€§å¯èƒ½ä¸‹é™ã€‚<br>
        æ¸©åº¦è¶…è¿‡ 1.5 é€šå¸¸ä¼šå¯¼è‡´è¾“å‡ºä¸å¯æ§ã€‚
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- Demo 3: Context Window & Attention Dilution  -->
  <!-- ============================================ -->
  <div id="tab3" class="panel">
    <div class="card">
      <div class="section-title">
        <span class="icon">ğŸ”</span>
        ä¸Šä¸‹æ–‡çª—å£ä¸æ³¨æ„åŠ›ç¨€é‡Š (Attention Dilution)
      </div>
      <p class="description">
        Transformer çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œæ¯ä¸ªä½ç½®çš„æ³¨æ„åŠ›æƒé‡ä¹‹å’Œæ’ä¸º 1ï¼ˆsoftmax å½’ä¸€åŒ–ï¼‰ã€‚
        è¿™æ„å‘³ç€ä¸Šä¸‹æ–‡è¶Šé•¿ï¼Œæ¯ä¸ª token å¹³å‡åˆ†åˆ°çš„æ³¨æ„åŠ›å°±è¶Šå°‘ã€‚
        è¿™å°±æ˜¯æ‰€è°“çš„ <strong>"Lost in the Middle"</strong> ç°è±¡â€”â€”é•¿æ–‡æœ¬ä¸­é—´çš„ä¿¡æ¯æœ€å®¹æ˜“è¢«é—å¿˜ã€‚
      </p>

      <div class="formula">
        å¹³å‡æ³¨æ„åŠ› = 1/N &nbsp;&nbsp;(N = ä¸Šä¸‹æ–‡é•¿åº¦)
      </div>

      <div class="slider-group">
        <div class="slider-label">
          <span>ä¸Šä¸‹æ–‡é•¿åº¦ N</span>
          <span class="slider-value" id="dilution-len-val">500</span>
        </div>
        <input type="range" id="dilution-len" min="0" max="100" value="20" step="1" oninput="updateDilution()">
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0;">
        <div style="text-align:center; padding: 12px; background: rgba(56,189,248,0.08); border-radius: 10px; border: 1px solid rgba(56,189,248,0.2);">
          <div style="font-size:0.8rem; color:var(--text-dim);">ä¸Šä¸‹æ–‡é•¿åº¦</div>
          <div style="font-size:1.5rem; font-weight:700; color:var(--primary); font-family:monospace;" id="dilution-n-display">500</div>
        </div>
        <div style="text-align:center; padding: 12px; background: rgba(245,158,11,0.08); border-radius: 10px; border: 1px solid rgba(245,158,11,0.2);">
          <div style="font-size:0.8rem; color:var(--text-dim);">å¹³å‡æ³¨æ„åŠ›æƒé‡</div>
          <div style="font-size:1.5rem; font-weight:700; color:var(--warning); font-family:monospace;" id="dilution-avg-display">0.200%</div>
        </div>
      </div>

      <div style="margin-bottom:8px; font-size:0.85rem; color:var(--text-dim);">
        æ³¨æ„åŠ›çƒ­åŠ›å›¾ â€” é¢œè‰²è¶Šäº®è¡¨ç¤ºæ³¨æ„åŠ›è¶Šé«˜ï¼ˆU å½¢åˆ†å¸ƒ + Lost in the Middleï¼‰
      </div>
      <canvas id="heatmap-canvas" height="200"></canvas>

      <div class="legend">
        <span>ä½æ³¨æ„åŠ›</span>
        <div class="legend-bar" style="background: linear-gradient(90deg, #0f172a, #1e40af, #38bdf8, #fbbf24, #ef4444);"></div>
        <span>é«˜æ³¨æ„åŠ›</span>
      </div>

      <canvas id="dilution-curve-canvas" height="240"></canvas>

      <div class="tip-box">
        é•¿æ–‡æœ¬ä¸­ï¼ŒæŠŠå…³é”®ä¿¡æ¯æ”¾åœ¨<strong>å¼€å¤´</strong>æˆ–<strong>ç»“å°¾</strong>ï¼Œä¸è¦åŸ‹åœ¨ä¸­é—´ï¼<br>
        å¦‚æœå¿…é¡»æ”¾åœ¨ä¸­é—´ï¼Œå¯ä»¥ç”¨ç‰¹æ®Šæ ‡è®°ï¼ˆå¦‚ "ã€é‡è¦ã€‘"ï¼‰æ¥å¸å¼•æ¨¡å‹æ³¨æ„åŠ›ã€‚<br>
        ä¸Šä¸‹æ–‡ä» 1K å¢é•¿åˆ° 100K æ—¶ï¼Œå¹³å‡æ³¨æ„åŠ›ä¸‹é™äº† 100 å€ã€‚
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- Demo 4: Chain-of-Thought                     -->
  <!-- ============================================ -->
  <div id="tab4" class="panel">
    <div class="card">
      <div class="section-title">
        <span class="icon">ğŸ”—</span>
        Chain-of-Thought çš„æ³¨æ„åŠ›åŸç†
      </div>
      <p class="description">
        ä¸ºä»€ä¹ˆè®©æ¨¡å‹"ä¸€æ­¥æ­¥æ€è€ƒ"æ•ˆæœæ›´å¥½ï¼Ÿä»æ³¨æ„åŠ›æœºåˆ¶çš„è§’åº¦çœ‹ï¼Œ<strong>CoTï¼ˆæ€ç»´é“¾ï¼‰</strong>åœ¨é—®é¢˜å’Œç­”æ¡ˆä¹‹é—´
        æ’å…¥äº†ä¸­é—´æ¨ç†æ­¥éª¤ã€‚æ¯ä¸ªæ­¥éª¤éƒ½ä¸ºä¸‹ä¸€æ­¥æä¾›äº†<strong>è¿‘è·ç¦»çš„ä¸Šä¸‹æ–‡</strong>ï¼Œä½¿æ³¨æ„åŠ›ä¸å¿…è·¨è¶Šè¿‡è¿œçš„è·ç¦»æ¥
        è·å–å…³é”®ä¿¡æ¯ã€‚è¿™å°±åƒåœ¨æ²³æµä¸­æ”¾ç½®"å«è„šçŸ³"â€”â€”æ¯ä¸€æ­¥éƒ½è®©ä¸‹ä¸€æ­¥èµ°å¾—æ›´ç¨³ã€‚
      </p>

      <div class="cot-comparison">
        <!-- Without CoT -->
        <div class="cot-panel bad">
          <h4 style="color:var(--danger);">æ²¡æœ‰ CoTï¼šç›´æ¥å›ç­”</h4>
          <div class="cot-flow" id="no-cot-flow">
            <div class="cot-node question" id="nc-q">é—®é¢˜</div>
            <span class="cot-arrow" id="nc-arrow">&rarr;</span>
            <div class="cot-node answer" id="nc-a">ç­”æ¡ˆ</div>
          </div>
          <canvas id="no-cot-canvas" height="100"></canvas>
          <div style="font-size:0.8rem; color:var(--text-dim); margin-top:8px;">
            æ³¨æ„åŠ›å¿…é¡»<strong style="color:var(--danger);">è¿œè·ç¦»è·³è·ƒ</strong>ï¼Œå®¹æ˜“ä¸¢å¤±å…³é”®ä¿¡æ¯
          </div>
        </div>

        <!-- With CoT -->
        <div class="cot-panel good">
          <h4 style="color:var(--accent);">ä½¿ç”¨ CoTï¼šé€æ­¥æ¨ç†</h4>
          <div class="cot-flow" id="cot-flow">
            <div class="cot-node question" id="c-q">é—®é¢˜</div>
            <span class="cot-arrow" id="c-a1">&rarr;</span>
            <div class="cot-node step" id="c-s1">æ­¥éª¤1</div>
            <span class="cot-arrow" id="c-a2">&rarr;</span>
            <div class="cot-node step" id="c-s2">æ­¥éª¤2</div>
            <span class="cot-arrow" id="c-a3">&rarr;</span>
            <div class="cot-node step" id="c-s3">æ­¥éª¤3</div>
            <span class="cot-arrow" id="c-a4">&rarr;</span>
            <div class="cot-node answer" id="c-a">ç­”æ¡ˆ</div>
          </div>
          <canvas id="cot-canvas" height="100"></canvas>
          <div style="font-size:0.8rem; color:var(--text-dim); margin-top:8px;">
            æ¯æ­¥æ¨ç†éƒ½æä¾›<strong style="color:var(--accent);">è¿‘è·ç¦»ä¸Šä¸‹æ–‡</strong>ï¼Œæ³¨æ„åŠ›æ›´é›†ä¸­
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn" id="cot-play-btn" onclick="playCotAnimation()">æ’­æ”¾åŠ¨ç”»</button>
        <button class="btn" onclick="resetCotAnimation()">é‡ç½®</button>
      </div>

      <div class="card" style="margin-top: 20px;">
        <div class="section-title">
          <span class="icon">ğŸ“Š</span>
          æ³¨æ„åŠ›è·ç¦»å¯¹æ¯”
        </div>
        <canvas id="cot-distance-canvas" height="260"></canvas>
        <p class="description" style="margin-top:12px;">
          å·¦ä¾§ï¼šæ²¡æœ‰ CoT æ—¶ï¼Œç­”æ¡ˆå¿…é¡»"è¿œè·ç¦»"å…³æ³¨é—®é¢˜ä¸­çš„å…³é”®ä¿¡æ¯ï¼Œæ³¨æ„åŠ›å®¹æ˜“åˆ†æ•£ã€‚<br>
          å³ä¾§ï¼šä½¿ç”¨ CoT åï¼Œæ¯ä¸€æ­¥åªéœ€è¦å…³æ³¨"è¿‘è·ç¦»"çš„å‰ä¸€æ­¥ï¼Œä¿¡æ¯ä¼ é€’æ›´åŠ å¯é ã€‚<br>
          è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ <strong>"Let's think step by step"</strong> èƒ½æ˜¾è‘—æå‡å¤æ‚æ¨ç†ä»»åŠ¡çš„å‡†ç¡®ç‡ã€‚
        </p>
      </div>

      <div class="tip-box">
        è®©æ¨¡å‹"å…ˆæƒ³åç­”"â€”â€”æ¯ä¸€æ­¥æ¨ç†éƒ½ä¸ºä¸‹ä¸€æ­¥æä¾›è¿‘è·ç¦»çš„ä¸Šä¸‹æ–‡ã€‚<br>
        <strong>ç®€å•ä»»åŠ¡</strong>ï¼šç›´æ¥æé—®å³å¯ï¼Œä¸éœ€è¦ CoTã€‚<br>
        <strong>å¤æ‚æ¨ç†</strong>ï¼šä½¿ç”¨"è¯·ä¸€æ­¥æ­¥åˆ†æ"æˆ–"Let's think step by step"ã€‚<br>
        <strong>å¤šæ­¥è®¡ç®—</strong>ï¼šè¦æ±‚æ¨¡å‹"å…ˆåˆ—å‡ºå·²çŸ¥æ¡ä»¶ï¼Œå†é€æ­¥æ¨å¯¼"ã€‚
      </div>
    </div>
  </div>
</div>

<script>
// ==========================================
// Tab Navigation
// ==========================================
function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.tab === tabId);
  });
  document.querySelectorAll('.panel').forEach(function(panel) {
    panel.classList.toggle('active', panel.id === tabId);
  });
  reportHeight();
  // Initialize the active panel
  if (tabId === 'tab1') updatePrimacy();
  if (tabId === 'tab2') updateTemperature();
  if (tabId === 'tab3') updateDilution();
  if (tabId === 'tab4') { drawCotDistanceChart(); resetCotAnimation(); }
}

// ==========================================
// Utility: DPR-aware canvas sizing
// ==========================================
function setupCanvas(canvas, desiredHeight) {
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  var w = rect.width || canvas.parentElement.offsetWidth || 800;
  canvas.width = w * dpr;
  canvas.height = (desiredHeight || 300) * dpr;
  canvas.style.height = desiredHeight + 'px';
  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  return { ctx: ctx, w: w, h: desiredHeight };
}

// ==========================================
// Demo 1: Primacy-Recency Effect
// ==========================================
var primacySentences = [
  "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¿»è¯‘åŠ©æ‰‹",
  "è¯·å°†ä»¥ä¸‹å†…å®¹ç¿»è¯‘æˆè‹±æ–‡",
  "ä¿æŒåŸæ–‡çš„è¯­æ°”å’Œé£æ ¼",
  "æ³¨æ„ä¸“ä¸šæœ¯è¯­çš„å‡†ç¡®æ€§",
  "ä»Šå¤©å¤©æ°”ä¸é”™é€‚åˆå‡ºé—¨",
  "æˆ‘æ˜¨å¤©ä¹°äº†ä¸€æœ¬æ–°ä¹¦",
  "è¿™ä¸ªé¡¹ç›®éœ€è¦æ›´å¤šäººæ‰‹",
  "ä¸‹å‘¨äºŒæœ‰ä¸€ä¸ªé‡è¦ä¼šè®®",
  "æ•°æ®åˆ†ææŠ¥å‘Šå·²å®Œæˆ",
  "è¯·æ£€æŸ¥ä»£ç ä¸­çš„é”™è¯¯",
  "æœåŠ¡å™¨éœ€è¦å‡çº§å†…å­˜",
  "å®¢æˆ·åé¦ˆéå¸¸ç§¯æ",
  "æ–°åŠŸèƒ½å°†åœ¨ä¸‹å‘¨å‘å¸ƒ",
  "å›¢é˜Ÿåˆä½œæ•ˆç‡å¾ˆé«˜",
  "æ–‡æ¡£éœ€è¦åŠæ—¶æ›´æ–°",
  "å®‰å…¨å®¡æŸ¥å·²ç»é€šè¿‡",
  "æ€§èƒ½ä¼˜åŒ–æ•ˆæœæ˜¾è‘—",
  "ç”¨æˆ·ä½“éªŒæŒç»­æ”¹å–„",
  "æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡",
  "éƒ¨ç½²æµç¨‹å·²è‡ªåŠ¨åŒ–",
  "ç›‘æ§ç³»ç»Ÿè¿è¡Œæ­£å¸¸",
  "æ—¥å¿—åˆ†æå‘ç°å¼‚å¸¸",
  "ç¼“å­˜å‘½ä¸­ç‡å¾ˆé«˜",
  "ç½‘ç»œå»¶è¿Ÿæœ‰æ‰€ä¸‹é™",
  "å­˜å‚¨ç©ºé—´å³å°†ä¸è¶³",
  "å¤‡ä»½ä»»åŠ¡å®šæ—¶æ‰§è¡Œ",
  "æƒé™é…ç½®å·²æ›´æ–°",
  "æ¥å£æ–‡æ¡£å·²åŒæ­¥",
  "å›å¤æ—¶ä½¿ç”¨ä¸­æ–‡",
  "ä¿æŒç®€æ´ä¸“ä¸šçš„é£æ ¼"
];

function computePrimacyWeights(n, strength) {
  var weights = [];
  var s = strength;
  for (var i = 0; i < n; i++) {
    var posRatio = i / (n - 1);
    // U-shape: high at beginning and end, low in middle
    var uShape = Math.pow(1 - posRatio, 1.5) * s + Math.pow(posRatio, 2.5) * s * 1.2;
    // Baseline
    var baseline = (1 - s) * 0.5;
    // Add some noise for realism
    var noise = Math.sin(i * 3.7 + n * 0.3) * 0.03 + Math.cos(i * 2.1) * 0.02;
    weights.push(Math.max(0.02, uShape + baseline + noise));
  }
  // Normalize
  var sum = weights.reduce(function(a, b) { return a + b; }, 0);
  return weights.map(function(w) { return w / sum; });
}

function updatePrimacy() {
  var n = parseInt(document.getElementById('primacy-len').value);
  var strength = parseInt(document.getElementById('primacy-strength').value) / 100;
  document.getElementById('primacy-len-val').textContent = n;
  document.getElementById('primacy-strength-val').textContent = strength.toFixed(2);

  var weights = computePrimacyWeights(n, strength);
  drawPrimacyChart(weights, n);
}

function drawPrimacyChart(weights, n) {
  var canvas = document.getElementById('primacy-canvas');
  var s = setupCanvas(canvas, 320);
  var ctx = s.ctx, w = s.w, h = s.h;
  var maxW = Math.max.apply(null, weights);

  var padLeft = 50, padRight = 20, padTop = 40, padBottom = 60;
  var chartW = w - padLeft - padRight;
  var chartH = h - padTop - padBottom;

  ctx.clearRect(0, 0, w, h);

  // Grid lines
  ctx.strokeStyle = 'rgba(51,65,85,0.4)';
  ctx.lineWidth = 0.5;
  for (var i = 0; i <= 5; i++) {
    var y = padTop + chartH - (i / 5) * chartH;
    ctx.beginPath();
    ctx.moveTo(padLeft, y);
    ctx.lineTo(w - padRight, y);
    ctx.stroke();
    ctx.fillStyle = '#94a3b8';
    ctx.font = '11px monospace';
    ctx.textAlign = 'right';
    ctx.fillText((maxW * i / 5 * 100).toFixed(1) + '%', padLeft - 6, y + 4);
  }

  // Bars
  var barW = Math.max(2, (chartW / n) - 2);
  var gap = (chartW - barW * n) / (n + 1);

  for (var i = 0; i < n; i++) {
    var x = padLeft + gap + i * (barW + gap);
    var barH = (weights[i] / maxW) * chartH;
    var y = padTop + chartH - barH;

    // Color gradient: edges are bright, middle is dim
    var posRatio = i / (n - 1);
    var edgeness = Math.pow(1 - 2 * Math.abs(posRatio - 0.5), 1);
    var r, g, b;
    if (posRatio < 0.15 || posRatio > 0.85) {
      r = 56; g = 189; b = 248; // primary blue
    } else if (posRatio < 0.3 || posRatio > 0.7) {
      r = 139; g = 92; b = 246; // purple
    } else {
      r = 71; g = 85; b = 105; // dim
    }

    var grad = ctx.createLinearGradient(x, y, x, padTop + chartH);
    grad.addColorStop(0, 'rgba(' + r + ',' + g + ',' + b + ',0.9)');
    grad.addColorStop(1, 'rgba(' + r + ',' + g + ',' + b + ',0.3)');
    ctx.fillStyle = grad;

    ctx.beginPath();
    ctx.roundRect(x, y, barW, barH, [3, 3, 0, 0]);
    ctx.fill();

    // Labels for first, middle, last
    if (i === 0 || i === n - 1 || i === Math.floor(n / 2)) {
      ctx.fillStyle = '#94a3b8';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.save();
      ctx.translate(x + barW / 2, padTop + chartH + 8);
      var label = i === 0 ? 'å¼€å¤´' : (i === n - 1 ? 'ç»“å°¾' : 'ä¸­é—´');
      ctx.fillText(label, 0, 10);
      ctx.fillText('(' + (i + 1) + ')', 0, 22);
      ctx.restore();
    }
  }

  // U-shape overlay curve
  ctx.beginPath();
  ctx.strokeStyle = 'rgba(245, 158, 11, 0.7)';
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 3]);
  for (var i = 0; i < n; i++) {
    var x = padLeft + gap + i * (barW + gap) + barW / 2;
    var barH = (weights[i] / maxW) * chartH;
    var y = padTop + chartH - barH;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
  ctx.setLineDash([]);

  // Title
  ctx.fillStyle = '#e2e8f0';
  ctx.font = 'bold 13px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('æœ€åä¸€ä¸ª token å¯¹å„ä½ç½®çš„æ³¨æ„åŠ›æƒé‡åˆ†å¸ƒ (U å½¢æ›²çº¿)', w / 2, 20);

  // Labels
  ctx.fillStyle = '#38bdf8';
  ctx.font = '11px sans-serif';
  var firstX = padLeft + gap + barW / 2;
  ctx.fillText('é«˜æ³¨æ„åŠ›', firstX + 20, padTop + 14);
  var lastX = padLeft + gap + (n - 1) * (barW + gap) + barW / 2;
  ctx.fillText('é«˜æ³¨æ„åŠ›', lastX - 20, padTop + 14);
  ctx.fillStyle = '#64748b';
  var midX = padLeft + gap + Math.floor(n / 2) * (barW + gap) + barW / 2;
  ctx.fillText('ä½æ³¨æ„åŠ›(ç¨€é‡Š)', midX, padTop + 14);
}

// ==========================================
// Demo 2: Temperature Scaling
// ==========================================
var vocabWords = ["çŒ«", "ç‹—", "é¸Ÿ", "é±¼", "å…”", "é©¬", "è™", "é¾™", "è›‡", "é¼ "];
var baseLogits = [3.5, 2.8, 2.1, 1.6, 1.2, 0.9, 0.5, 0.2, -0.3, -0.8];

function softmaxWithTemp(logits, temperature) {
  var t = Math.max(0.01, temperature);
  var scaled = logits.map(function(l) { return l / t; });
  var maxVal = Math.max.apply(null, scaled);
  var exps = scaled.map(function(s) { return Math.exp(s - maxVal); });
  var sumExp = exps.reduce(function(a, b) { return a + b; }, 0);
  return exps.map(function(e) { return e / sumExp; });
}

function updateTemperature() {
  var rawVal = parseInt(document.getElementById('temp-slider').value);
  var temp = rawVal / 100;
  document.getElementById('temp-val').textContent = temp.toFixed(2);

  var probs = softmaxWithTemp(baseLogits, temp);

  // Update indicator
  var modeEl = document.getElementById('temp-mode');
  var descEl = document.getElementById('temp-desc');
  var emojiEl = document.getElementById('temp-emoji');
  var indicator = document.getElementById('temp-indicator');

  if (temp < 0.4) {
    modeEl.textContent = 'ç¡®å®šæ€§æ¨¡å¼';
    modeEl.style.color = '#38bdf8';
    descEl.textContent = 'è¾“å‡ºé«˜åº¦ç¡®å®šï¼Œé€‚åˆå†™ä»£ç ã€æ•°å­¦è®¡ç®—';
    emojiEl.textContent = 'ğŸ¯';
    indicator.style.borderColor = 'rgba(56,189,248,0.3)';
  } else if (temp < 0.8) {
    modeEl.textContent = 'åç¡®å®šæ€§';
    modeEl.style.color = '#22c55e';
    descEl.textContent = 'è¾ƒç¡®å®šä½†æœ‰ä¸€å®šå¤šæ ·æ€§';
    emojiEl.textContent = 'âœ…';
    indicator.style.borderColor = 'rgba(34,197,94,0.3)';
  } else if (temp < 1.2) {
    modeEl.textContent = 'é»˜è®¤ / å¹³è¡¡';
    modeEl.style.color = '#f59e0b';
    descEl.textContent = 'å¹³è¡¡çš„è¾“å‡ºåˆ†å¸ƒï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯';
    emojiEl.textContent = 'âš–ï¸';
    indicator.style.borderColor = 'rgba(245,158,11,0.3)';
  } else if (temp < 1.6) {
    modeEl.textContent = 'åˆ›é€ æ€§æ¨¡å¼';
    modeEl.style.color = '#8b5cf6';
    descEl.textContent = 'è¾“å‡ºæ›´å¤šæ ·åŒ–ï¼Œé€‚åˆåˆ›æ„å†™ä½œ';
    emojiEl.textContent = 'ğŸ¨';
    indicator.style.borderColor = 'rgba(139,92,246,0.3)';
  } else {
    modeEl.textContent = 'é«˜éšæœºæ€§';
    modeEl.style.color = '#ef4444';
    descEl.textContent = 'è¾“å‡ºä¸å¯é¢„æµ‹ï¼Œå®¹æ˜“ä¸è¿è´¯';
    emojiEl.textContent = 'ğŸ²';
    indicator.style.borderColor = 'rgba(239,68,68,0.3)';
  }

  // Draw bars
  drawTempBars(probs);
  drawTempCurve(temp);
}

function drawTempBars(probs) {
  var container = document.getElementById('temp-bars');
  var maxProb = Math.max.apply(null, probs);
  var html = '';
  for (var i = 0; i < vocabWords.length; i++) {
    var pct = (probs[i] * 100).toFixed(1);
    var widthPct = (probs[i] / maxProb * 100).toFixed(1);
    var hue;
    if (i === 0) hue = '199,89%,56%'; // primary
    else if (i < 3) hue = '142,71%,45%'; // accent
    else if (i < 6) hue = '256,58%,66%'; // purple
    else hue = '215,14%,34%'; // dim

    html += '<div class="dist-bar-row">' +
      '<div class="dist-bar-label">"' + vocabWords[i] + '"</div>' +
      '<div class="dist-bar-track">' +
        '<div class="dist-bar-fill" style="width:' + widthPct + '%; background: hsla(' + hue + ',0.8);">' +
          (probs[i] > 0.03 ? pct + '%' : '') +
        '</div>' +
      '</div>' +
    '</div>';
  }
  container.innerHTML = html;
}

function drawTempCurve(temperature) {
  var canvas = document.getElementById('temp-canvas');
  var s = setupCanvas(canvas, 260);
  var ctx = s.ctx, w = s.w, h = s.h;

  var padLeft = 50, padRight = 20, padTop = 35, padBottom = 40;
  var chartW = w - padLeft - padRight;
  var chartH = h - padTop - padBottom;

  ctx.clearRect(0, 0, w, h);

  // Draw curves for multiple temperatures, highlight current
  var temps = [0.1, 0.5, 1.0, 1.5, 2.0];
  var colors = ['#38bdf8', '#22c55e', '#f59e0b', '#8b5cf6', '#ef4444'];
  var labels = ['T=0.1', 'T=0.5', 'T=1.0', 'T=1.5', 'T=2.0'];

  // Grid
  ctx.strokeStyle = 'rgba(51,65,85,0.3)';
  ctx.lineWidth = 0.5;
  for (var i = 0; i <= 4; i++) {
    var y = padTop + (i / 4) * chartH;
    ctx.beginPath();
    ctx.moveTo(padLeft, y);
    ctx.lineTo(w - padRight, y);
    ctx.stroke();
  }

  // X axis labels
  ctx.fillStyle = '#94a3b8';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  for (var i = 0; i < vocabWords.length; i++) {
    var x = padLeft + (i / (vocabWords.length - 1)) * chartW;
    ctx.fillText('"' + vocabWords[i] + '"', x, h - 8);
  }

  // Draw reference curves
  for (var t = 0; t < temps.length; t++) {
    var probs = softmaxWithTemp(baseLogits, temps[t]);
    var maxP = 1.0;

    ctx.beginPath();
    ctx.strokeStyle = colors[t];
    ctx.globalAlpha = 0.3;
    ctx.lineWidth = 1.5;
    ctx.setLineDash([4, 4]);

    for (var i = 0; i < probs.length; i++) {
      var x = padLeft + (i / (probs.length - 1)) * chartW;
      var y = padTop + chartH - (probs[i] / maxP) * chartH;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.globalAlpha = 1;

    // Label
    var labelX = w - padRight + 2;
    var lastY = padTop + chartH - (probs[probs.length - 1] / maxP) * chartH;
    ctx.fillStyle = colors[t];
    ctx.font = '9px monospace';
    ctx.textAlign = 'left';
  }

  // Draw current temperature curve (bold)
  var currentProbs = softmaxWithTemp(baseLogits, temperature);
  ctx.beginPath();
  ctx.lineWidth = 3;

  // Pick color based on temperature
  var curColor;
  if (temperature < 0.3) curColor = '#38bdf8';
  else if (temperature < 0.7) curColor = '#22c55e';
  else if (temperature < 1.2) curColor = '#f59e0b';
  else if (temperature < 1.6) curColor = '#8b5cf6';
  else curColor = '#ef4444';

  ctx.strokeStyle = curColor;
  ctx.shadowColor = curColor;
  ctx.shadowBlur = 8;

  for (var i = 0; i < currentProbs.length; i++) {
    var x = padLeft + (i / (currentProbs.length - 1)) * chartW;
    var y = padTop + chartH - (currentProbs[i] / 1.0) * chartH;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
  ctx.shadowBlur = 0;

  // Draw dots
  for (var i = 0; i < currentProbs.length; i++) {
    var x = padLeft + (i / (currentProbs.length - 1)) * chartW;
    var y = padTop + chartH - (currentProbs[i] / 1.0) * chartH;
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fillStyle = curColor;
    ctx.fill();
  }

  // Title
  ctx.fillStyle = '#e2e8f0';
  ctx.font = 'bold 12px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('æ¦‚ç‡åˆ†å¸ƒæ›²çº¿ (å½“å‰ T=' + temperature.toFixed(2) + 'ï¼Œè™šçº¿ä¸ºå‚è€ƒæ¸©åº¦)', w / 2, 18);

  // Y-axis label
  ctx.fillStyle = '#94a3b8';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'right';
  ctx.fillText('100%', padLeft - 6, padTop + 4);
  ctx.fillText('0%', padLeft - 6, padTop + chartH + 4);
}

// ==========================================
// Demo 3: Attention Dilution
// ==========================================
function mapSliderToN(val) {
  // Exponential mapping: 0-100 â†’ 100-128000
  var minLog = Math.log(100);
  var maxLog = Math.log(128000);
  return Math.round(Math.exp(minLog + (val / 100) * (maxLog - minLog)));
}

function updateDilution() {
  var rawVal = parseInt(document.getElementById('dilution-len').value);
  var n = mapSliderToN(rawVal);
  document.getElementById('dilution-len-val').textContent = n.toLocaleString();
  document.getElementById('dilution-n-display').textContent = n.toLocaleString();
  var avg = (1 / n * 100);
  document.getElementById('dilution-avg-display').textContent = avg < 0.001 ? avg.toExponential(2) : avg.toFixed(3) + '%';

  drawDilutionHeatmap(n);
  drawDilutionCurve(n);
}

function dilutionAttention(posRatio, n) {
  // U-shape: high at edges, low in middle; more pronounced with larger n
  var distFromEdge = Math.min(posRatio, 1 - posRatio);
  var midPenalty = Math.pow(distFromEdge * 2, 1.5);
  var base = 1.0 / n;
  var edge = base * (3 + Math.log10(n));
  var mid = base * (0.3 + 0.5 / Math.log10(n + 1));
  return mid + (edge - mid) * (1 - midPenalty);
}

function drawDilutionHeatmap(n) {
  var canvas = document.getElementById('heatmap-canvas');
  var s = setupCanvas(canvas, 200);
  var ctx = s.ctx, w = s.w, h = s.h;

  ctx.clearRect(0, 0, w, h);

  var cols = Math.min(n, 80);
  var rows = 5;
  var padX = 30, padY = 30;
  var cellW = (w - 2 * padX) / cols;
  var cellH = (h - 2 * padY) / rows;

  // Compute attention values for one query attending to all keys
  var attentions = [];
  for (var c = 0; c < cols; c++) {
    var posRatio = c / (cols - 1);
    attentions.push(dilutionAttention(posRatio, n));
  }
  var maxAttn = Math.max.apply(null, attentions);
  var minAttn = Math.min.apply(null, attentions);

  // Draw rows (different query positions)
  var queryPositions = [0.0, 0.25, 0.5, 0.75, 1.0];
  var queryLabels = ['å¼€å¤´', '1/4å¤„', 'ä¸­é—´', '3/4å¤„', 'ç»“å°¾'];

  for (var r = 0; r < rows; r++) {
    // Label
    ctx.fillStyle = '#94a3b8';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(queryLabels[r], padX - 4, padY + r * cellH + cellH / 2 + 3);

    for (var c = 0; c < cols; c++) {
      var posRatio = c / (cols - 1);
      // For each query position, the attention is modulated
      var queryPos = queryPositions[r];
      var distToQuery = Math.abs(posRatio - queryPos);
      var localBoost = Math.exp(-distToQuery * 3) * 0.5;
      var val = attentions[c] + localBoost * (attentions[c]);
      var normVal = Math.min(1, (val - minAttn * 0.8) / (maxAttn * 1.5 - minAttn * 0.8));

      // Color: dark blue â†’ blue â†’ cyan â†’ yellow â†’ red
      var red, green, blue;
      if (normVal < 0.25) {
        var t = normVal / 0.25;
        red = Math.round(15 + t * 15);
        green = Math.round(23 + t * 41);
        blue = Math.round(42 + t * 130);
      } else if (normVal < 0.5) {
        var t = (normVal - 0.25) / 0.25;
        red = Math.round(30 + t * 26);
        green = Math.round(64 + t * 125);
        blue = Math.round(172 + t * 76);
      } else if (normVal < 0.75) {
        var t = (normVal - 0.5) / 0.25;
        red = Math.round(56 + t * 195);
        green = Math.round(189 + t * 2);
        blue = Math.round(248 - t * 224);
      } else {
        var t = (normVal - 0.75) / 0.25;
        red = Math.round(251 - t * 12);
        green = Math.round(191 - t * 123);
        blue = Math.round(24 - t * 24);
      }

      ctx.fillStyle = 'rgb(' + red + ',' + green + ',' + blue + ')';
      ctx.fillRect(padX + c * cellW, padY + r * cellH, cellW - 1, cellH - 1);
    }
  }

  // Title
  ctx.fillStyle = '#e2e8f0';
  ctx.font = 'bold 11px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('æ³¨æ„åŠ›çƒ­åŠ›å›¾ (N=' + n.toLocaleString() + ')', w / 2, 16);

  // X-axis labels
  ctx.fillStyle = '#94a3b8';
  ctx.font = '9px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('å¼€å¤´', padX + 10, h - 6);
  ctx.fillText('ä¸­é—´', w / 2, h - 6);
  ctx.fillText('ç»“å°¾', w - padX - 10, h - 6);
}

function drawDilutionCurve(n) {
  var canvas = document.getElementById('dilution-curve-canvas');
  var s = setupCanvas(canvas, 240);
  var ctx = s.ctx, w = s.w, h = s.h;

  var padLeft = 55, padRight = 20, padTop = 35, padBottom = 45;
  var chartW = w - padLeft - padRight;
  var chartH = h - padTop - padBottom;

  ctx.clearRect(0, 0, w, h);

  // Grid
  ctx.strokeStyle = 'rgba(51,65,85,0.3)';
  ctx.lineWidth = 0.5;
  for (var i = 0; i <= 5; i++) {
    var y = padTop + (i / 5) * chartH;
    ctx.beginPath();
    ctx.moveTo(padLeft, y);
    ctx.lineTo(w - padRight, y);
    ctx.stroke();
  }

  // Draw multiple N curves for comparison
  var nValues = [100, 500, 2000, 10000, 50000, 128000];
  var nColors = ['#38bdf8', '#22c55e', '#f59e0b', '#8b5cf6', '#ef4444', '#94a3b8'];
  var points = 80;

  // Find global max for scaling
  var globalMax = 0;
  for (var ni = 0; ni < nValues.length; ni++) {
    for (var p = 0; p < points; p++) {
      var posRatio = p / (points - 1);
      var val = dilutionAttention(posRatio, nValues[ni]);
      if (val > globalMax) globalMax = val;
    }
  }

  // Draw reference curves
  for (var ni = 0; ni < nValues.length; ni++) {
    var isCurrentScale = Math.abs(Math.log(nValues[ni]) - Math.log(n)) < 0.5;
    ctx.beginPath();
    ctx.strokeStyle = nColors[ni];
    ctx.lineWidth = isCurrentScale ? 3 : 1;
    ctx.globalAlpha = isCurrentScale ? 1 : 0.3;
    if (!isCurrentScale) ctx.setLineDash([3, 3]);

    for (var p = 0; p < points; p++) {
      var posRatio = p / (points - 1);
      var val = dilutionAttention(posRatio, nValues[ni]);
      var x = padLeft + posRatio * chartW;
      var y = padTop + chartH - (val / globalMax) * chartH;
      if (p === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.globalAlpha = 1;

    // Label
    if (isCurrentScale || ni % 2 === 0) {
      var labelY = padTop + chartH - (dilutionAttention(0, nValues[ni]) / globalMax) * chartH;
      ctx.fillStyle = nColors[ni];
      ctx.font = (isCurrentScale ? 'bold ' : '') + '9px monospace';
      ctx.textAlign = 'left';
      ctx.fillText('N=' + nValues[ni].toLocaleString(), padLeft + 4, labelY - 4);
    }
  }

  // Draw current N curve
  ctx.beginPath();
  ctx.strokeStyle = '#38bdf8';
  ctx.lineWidth = 3;
  ctx.shadowColor = '#38bdf8';
  ctx.shadowBlur = 6;

  for (var p = 0; p < points; p++) {
    var posRatio = p / (points - 1);
    var val = dilutionAttention(posRatio, n);
    var x = padLeft + posRatio * chartW;
    var y = padTop + chartH - (val / globalMax) * chartH;
    if (p === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
  ctx.shadowBlur = 0;

  // Fill under current curve
  ctx.lineTo(padLeft + chartW, padTop + chartH);
  ctx.lineTo(padLeft, padTop + chartH);
  ctx.closePath();
  ctx.fillStyle = 'rgba(56,189,248,0.08)';
  ctx.fill();

  // Title
  ctx.fillStyle = '#e2e8f0';
  ctx.font = 'bold 12px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('å„ä½ç½®æ³¨æ„åŠ›åˆ†å¸ƒ (å½“å‰ N=' + n.toLocaleString() + ')', w / 2, 18);

  // X labels
  ctx.fillStyle = '#94a3b8';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('å¼€å¤´', padLeft, h - 8);
  ctx.fillText('ä¸­é—´', padLeft + chartW / 2, h - 8);
  ctx.fillText('ç»“å°¾', padLeft + chartW, h - 8);

  // Y label
  ctx.textAlign = 'right';
  ctx.fillText('æ³¨æ„åŠ›', padLeft - 6, padTop - 4);
}

// ==========================================
// Demo 4: Chain-of-Thought
// ==========================================
var cotAnimFrame = 0;
var cotAnimRunning = false;
var cotAnimTimer = null;

function resetCotAnimation() {
  cotAnimRunning = false;
  cotAnimFrame = 0;
  if (cotAnimTimer) { clearTimeout(cotAnimTimer); cotAnimTimer = null; }

  // Reset all nodes
  var allNodes = document.querySelectorAll('.cot-node');
  allNodes.forEach(function(n) { n.classList.remove('active', 'glow-pulse'); });
  var allArrows = document.querySelectorAll('.cot-arrow');
  allArrows.forEach(function(a) { a.classList.remove('active'); });

  drawNoCotAttention(-1);
  drawCotAttention(-1);
  drawCotDistanceChart();
}

function playCotAnimation() {
  if (cotAnimRunning) return;
  resetCotAnimation();
  cotAnimRunning = true;

  var steps = [
    // No CoT: question highlights, then big jump to answer
    function() {
      document.getElementById('nc-q').classList.add('active', 'glow-pulse');
      drawNoCotAttention(0);
    },
    function() {
      document.getElementById('nc-arrow').classList.add('active');
    },
    function() {
      document.getElementById('nc-q').classList.remove('glow-pulse');
      document.getElementById('nc-a').classList.add('active', 'glow-pulse');
      drawNoCotAttention(1);
    },
    // CoT: question, step1, step2, step3, answer
    function() {
      document.getElementById('c-q').classList.add('active', 'glow-pulse');
      drawCotAttention(0);
    },
    function() {
      document.getElementById('c-a1').classList.add('active');
      document.getElementById('c-q').classList.remove('glow-pulse');
      document.getElementById('c-s1').classList.add('active', 'glow-pulse');
      drawCotAttention(1);
    },
    function() {
      document.getElementById('c-a2').classList.add('active');
      document.getElementById('c-s1').classList.remove('glow-pulse');
      document.getElementById('c-s2').classList.add('active', 'glow-pulse');
      drawCotAttention(2);
    },
    function() {
      document.getElementById('c-a3').classList.add('active');
      document.getElementById('c-s2').classList.remove('glow-pulse');
      document.getElementById('c-s3').classList.add('active', 'glow-pulse');
      drawCotAttention(3);
    },
    function() {
      document.getElementById('c-a4').classList.add('active');
      document.getElementById('c-s3').classList.remove('glow-pulse');
      document.getElementById('c-a').classList.add('active', 'glow-pulse');
      drawCotAttention(4);
    }
  ];

  var i = 0;
  function nextStep() {
    if (i < steps.length && cotAnimRunning) {
      steps[i]();
      i++;
      cotAnimTimer = setTimeout(nextStep, 700);
    } else {
      cotAnimRunning = false;
    }
  }
  nextStep();
}

function drawNoCotAttention(step) {
  var canvas = document.getElementById('no-cot-canvas');
  var s = setupCanvas(canvas, 100);
  var ctx = s.ctx, w = s.w, h = s.h;
  ctx.clearRect(0, 0, w, h);

  var qx = 40, ay = 50, ax = w - 40;

  if (step >= 0) {
    // Draw attention arc from answer to question
    ctx.beginPath();
    ctx.strokeStyle = step >= 1 ? 'rgba(239,68,68,0.7)' : 'rgba(56,189,248,0.3)';
    ctx.lineWidth = step >= 1 ? 3 : 1;
    ctx.setLineDash(step >= 1 ? [] : [4, 4]);

    var midX = (qx + ax) / 2;
    var arcH = 35;
    ctx.moveTo(qx, ay);
    ctx.quadraticCurveTo(midX, ay - arcH, ax, ay);
    ctx.stroke();
    ctx.setLineDash([]);

    if (step >= 1) {
      // Distance label
      ctx.fillStyle = '#ef4444';
      ctx.font = 'bold 11px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('é•¿è·ç¦»æ³¨æ„åŠ› (å®¹æ˜“ä¸¢å¤±)', midX, ay - arcH - 6);

      // Danger indicators
      ctx.fillStyle = 'rgba(239,68,68,0.2)';
      ctx.beginPath();
      ctx.arc(midX, ay - arcH + 5, 15, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#ef4444';
      ctx.font = '14px sans-serif';
      ctx.fillText('!', midX, ay - arcH + 10);
    }
  }

  // Nodes
  ctx.fillStyle = step >= 0 ? 'rgba(56,189,248,0.3)' : 'rgba(56,189,248,0.1)';
  ctx.beginPath();
  ctx.arc(qx, ay, 12, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#38bdf8';
  ctx.font = '9px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('Q', qx, ay + 3);

  ctx.fillStyle = step >= 1 ? 'rgba(34,197,94,0.3)' : 'rgba(34,197,94,0.1)';
  ctx.beginPath();
  ctx.arc(ax, ay, 12, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#22c55e';
  ctx.fillText('A', ax, ay + 3);
}

function drawCotAttention(step) {
  var canvas = document.getElementById('cot-canvas');
  var s = setupCanvas(canvas, 100);
  var ctx = s.ctx, w = s.w, h = s.h;
  ctx.clearRect(0, 0, w, h);

  var positions = [];
  var labels = ['Q', 'S1', 'S2', 'S3', 'A'];
  var colors = ['#38bdf8', '#8b5cf6', '#8b5cf6', '#8b5cf6', '#22c55e'];
  var numNodes = 5;
  var startX = 30, endX = w - 30;

  for (var i = 0; i < numNodes; i++) {
    positions.push(startX + (i / (numNodes - 1)) * (endX - startX));
  }

  var ay = 55;

  // Draw connections
  for (var i = 0; i < numNodes - 1; i++) {
    var isActive = step > i;
    ctx.beginPath();
    ctx.strokeStyle = isActive ? 'rgba(34,197,94,0.7)' : 'rgba(51,65,85,0.3)';
    ctx.lineWidth = isActive ? 2.5 : 1;

    var midX = (positions[i] + positions[i + 1]) / 2;
    ctx.moveTo(positions[i], ay);
    ctx.quadraticCurveTo(midX, ay - 18, positions[i + 1], ay);
    ctx.stroke();

    if (isActive) {
      ctx.fillStyle = '#22c55e';
      ctx.font = '8px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('çŸ­è·ç¦»', midX, ay - 20);
    }
  }

  // Nodes
  for (var i = 0; i < numNodes; i++) {
    var isActive = step >= i;
    var color = colors[i];
    ctx.fillStyle = isActive ? color + '44' : color + '11';
    ctx.beginPath();
    ctx.arc(positions[i], ay, 12, 0, Math.PI * 2);
    ctx.fill();

    if (isActive) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 1.5;
      ctx.stroke();
    }

    ctx.fillStyle = isActive ? color : '#475569';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(labels[i], positions[i], ay + 3);
  }
}

function drawCotDistanceChart() {
  var canvas = document.getElementById('cot-distance-canvas');
  var s = setupCanvas(canvas, 260);
  var ctx = s.ctx, w = s.w, h = s.h;

  var padLeft = 20, padRight = 20, padTop = 40, padBottom = 50;
  var chartW = w - padLeft - padRight;
  var chartH = h - padTop - padBottom;
  var midX = w / 2;

  ctx.clearRect(0, 0, w, h);

  // Title
  ctx.fillStyle = '#e2e8f0';
  ctx.font = 'bold 12px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('æ³¨æ„åŠ›è·ç¦»å¯¹æ¯”', w / 2, 20);

  // Left half: Without CoT
  var leftW = chartW / 2 - 10;
  ctx.fillStyle = 'rgba(239,68,68,0.06)';
  ctx.fillRect(padLeft, padTop, leftW, chartH);
  ctx.strokeStyle = 'rgba(239,68,68,0.2)';
  ctx.strokeRect(padLeft, padTop, leftW, chartH);

  ctx.fillStyle = '#ef4444';
  ctx.font = 'bold 11px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('æ²¡æœ‰ CoT', padLeft + leftW / 2, padTop + 18);

  // Draw attention as bars (distance)
  var noCotDistances = [{ label: 'ç­”æ¡ˆâ†’é—®é¢˜', dist: 100, color: '#ef4444' }];
  var barY = padTop + 40;
  var barMaxW = leftW - 40;

  ctx.fillStyle = '#94a3b8';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('æ³¨æ„åŠ›è·¨è¶Šè·ç¦»', padLeft + leftW / 2, barY);

  // Big red bar
  var bx = padLeft + 20;
  var by = barY + 16;
  var bw = barMaxW;
  var bh = 28;
  var grad = ctx.createLinearGradient(bx, 0, bx + bw, 0);
  grad.addColorStop(0, 'rgba(239,68,68,0.2)');
  grad.addColorStop(1, 'rgba(239,68,68,0.7)');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.roundRect(bx, by, bw, bh, 6);
  ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 11px sans-serif';
  ctx.fillText('100 tokens è·ç¦»', bx + bw / 2, by + bh / 2 + 4);

  // Attention accuracy
  ctx.fillStyle = '#ef4444';
  ctx.font = 'bold 24px sans-serif';
  ctx.fillText('60%', padLeft + leftW / 2, padTop + chartH - 40);
  ctx.fillStyle = '#94a3b8';
  ctx.font = '10px sans-serif';
  ctx.fillText('ä¿¡æ¯ä¿ç•™ç‡ (ä¼°è®¡)', padLeft + leftW / 2, padTop + chartH - 22);

  // Right half: With CoT
  var rightX = midX + 10;
  var rightW = chartW / 2 - 10;
  ctx.fillStyle = 'rgba(34,197,94,0.06)';
  ctx.fillRect(rightX, padTop, rightW, chartH);
  ctx.strokeStyle = 'rgba(34,197,94,0.2)';
  ctx.strokeRect(rightX, padTop, rightW, chartH);

  ctx.fillStyle = '#22c55e';
  ctx.font = 'bold 11px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('ä½¿ç”¨ CoT', rightX + rightW / 2, padTop + 18);

  ctx.fillStyle = '#94a3b8';
  ctx.font = '10px sans-serif';
  ctx.fillText('æ¯æ­¥æ³¨æ„åŠ›è·ç¦»', rightX + rightW / 2, barY);

  // Multiple small green bars
  var stepLabels = ['æ­¥éª¤1â†’é—®é¢˜', 'æ­¥éª¤2â†’æ­¥éª¤1', 'æ­¥éª¤3â†’æ­¥éª¤2', 'ç­”æ¡ˆâ†’æ­¥éª¤3'];
  var stepBarH = 18;
  var stepGap = 6;
  var maxStepW = rightW - 40;
  var stepStartY = barY + 14;

  for (var i = 0; i < stepLabels.length; i++) {
    var sy = stepStartY + i * (stepBarH + stepGap);
    var sw = maxStepW * 0.25; // Short distance

    var sGrad = ctx.createLinearGradient(rightX + 20, 0, rightX + 20 + sw, 0);
    sGrad.addColorStop(0, 'rgba(34,197,94,0.2)');
    sGrad.addColorStop(1, 'rgba(34,197,94,0.7)');
    ctx.fillStyle = sGrad;
    ctx.beginPath();
    ctx.roundRect(rightX + 20, sy, sw, stepBarH, 4);
    ctx.fill();

    ctx.fillStyle = '#e2e8f0';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(stepLabels[i], rightX + 20 + sw + 6, sy + stepBarH / 2 + 3);
  }

  // Attention accuracy
  ctx.fillStyle = '#22c55e';
  ctx.font = 'bold 24px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('95%', rightX + rightW / 2, padTop + chartH - 40);
  ctx.fillStyle = '#94a3b8';
  ctx.font = '10px sans-serif';
  ctx.fillText('ä¿¡æ¯ä¿ç•™ç‡ (ä¼°è®¡)', rightX + rightW / 2, padTop + chartH - 22);

  // VS label
  ctx.fillStyle = '#f59e0b';
  ctx.font = 'bold 16px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('VS', midX, padTop + chartH / 2 + 10);
}

// ==========================================
// Initialization
// ==========================================
function init() {
  updatePrimacy();
  updateTemperature();
  updateDilution();
  drawCotDistanceChart();
  resetCotAnimation();
}

// Handle window resize
var resizeTimer;
window.addEventListener('resize', function() {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(function() {
    var activePanel = document.querySelector('.panel.active');
    if (activePanel) {
      var tabId = activePanel.id;
      if (tabId === 'tab1') updatePrimacy();
      if (tabId === 'tab2') updateTemperature();
      if (tabId === 'tab3') updateDilution();
      if (tabId === 'tab4') { drawCotDistanceChart(); }
    }
    reportHeight();
  }, 200);
});

// roundRect polyfill
if (!CanvasRenderingContext2D.prototype.roundRect) {
  CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, radii) {
    var r = Array.isArray(radii) ? radii[0] : radii;
    r = Math.min(r, w / 2, h / 2);
    this.moveTo(x + r, y);
    this.lineTo(x + w - r, y);
    this.arcTo(x + w, y, x + w, y + r, r);
    this.lineTo(x + w, y + h - r);
    this.arcTo(x + w, y + h, x + w - r, y + h, r);
    this.lineTo(x + r, y + h);
    this.arcTo(x, y + h, x, y + h - r, r);
    this.lineTo(x, y + r);
    this.arcTo(x, y, x + r, y, r);
  };
}

// Initialize on load
window.addEventListener('DOMContentLoaded', init);

// ==========================================
// iframe height reporting
// ==========================================
function reportHeight() {
  var height = document.documentElement.scrollHeight;
  window.parent.postMessage({ type: 'iframeHeight', height: height }, '*');
}
window.addEventListener('load', function() { reportHeight(); setTimeout(reportHeight, 500); });
new ResizeObserver(reportHeight).observe(document.body);
</script>

</body>
</html>