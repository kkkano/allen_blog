<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­£åˆ™åŒ–æ•ˆæœåŠ¨ç”»</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1d4ed8 0%, #0f766e 100%);
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 14px 36px rgba(15, 23, 42, 0.12);
        }
        h1 {
            color: #1d4ed8;
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .btn-primary {
            background: #1d4ed8;
            color: white;
        }
        .btn-primary:hover {
            background: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 78, 216, 0.35);
        }
        .slider-container {
            background: #f4f8ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
        }
        .value-display {
            display: inline-block;
            background: #1d4ed8;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        .formula {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            border: 2px solid #1d4ed8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ æ­£åˆ™åŒ–æ•ˆæœåŠ¨ç”»æ¼”ç¤º</h1>

        <div class="formula">
            <strong>Ridgeå›å½’ç›®æ ‡å‡½æ•°ï¼š</strong> J(w) = MSE(w) + Î»||w||Â²
        </div>

        <div class="slider-container">
            <label>
                æ­£åˆ™åŒ–å‚æ•° Î» (Lambda):
                <span class="value-display" id="lambdaValue">0.0</span>
            </label>
            <input type="range" id="lambda" min="0" max="10" step="0.1" value="0">
            <small style="color: #666;">Î»=0: æ— æ­£åˆ™åŒ– | Î»å¢å¤§: æ­£åˆ™åŒ–å¢å¼º</small>
        </div>

        <div class="controls">
            <button class="btn-primary" onclick="animateRegularization()">â–¶ï¸ æ’­æ”¾åŠ¨ç”»</button>
            <button class="btn-primary" onclick="pauseAnimation()">â¸ï¸ æš‚åœ</button>
            <button class="btn-primary" onclick="resetAnimation()">ğŸ”„ é‡ç½®</button>
        </div>

        <div id="fittingChart"></div>
        <div id="weightsChart"></div>

        <div class="info-box">
            <strong>ğŸ“Š è§‚å¯Ÿè¦ç‚¹ï¼š</strong>
            <ul>
                <li><strong>Î» = 0</strong>: æ— æ­£åˆ™åŒ–ï¼Œæ¨¡å‹å¯èƒ½è¿‡æ‹Ÿåˆï¼Œæƒé‡å€¼è¾ƒå¤§ä¸”ä¸ç¨³å®š</li>
                <li><strong>Î» = 0.1-1</strong>: è½»åº¦æ­£åˆ™åŒ–ï¼Œæ¨¡å‹å¹³æ»‘åº¦æå‡ï¼Œæ³›åŒ–èƒ½åŠ›å¢å¼º</li>
                <li><strong>Î» = 1-5</strong>: ä¸­åº¦æ­£åˆ™åŒ–ï¼Œæƒé‡æ˜¾è‘—ç¼©å°ï¼Œæ›²çº¿æ›´åŠ å¹³æ»‘</li>
                <li><strong>Î» > 5</strong>: è¿‡åº¦æ­£åˆ™åŒ–ï¼Œæ¨¡å‹è¿‡äºç®€å•ï¼Œå¯èƒ½æ¬ æ‹Ÿåˆ</li>
                <li><strong>æƒé‡å˜åŒ–</strong>: è§‚å¯Ÿé«˜é˜¶é¡¹æƒé‡å¦‚ä½•éšÎ»å¢å¤§è€Œè¶‹è¿‘äº0</li>
            </ul>
        </div>
    </div>

    <script>
        let animationInterval = null;
        let currentLambda = 0;

        // ç”Ÿæˆæ•°æ®
        function generateData() {
            const X = [];
            const y = [];
            for (let i = 0; i < 30; i++) {
                const x = Math.random() * 4 - 2;
                const yTrue = 0.5 * x**3 - 2 * x**2 + x + 3;
                const yNoisy = yTrue + (Math.random() - 0.5) * 5;
                X.push(x);
                y.push(yNoisy);
            }
            return { X, y };
        }

        const data = generateData();

        // Ridgeå›å½’æ‹Ÿåˆ
        function ridgeFit(X, y, degree, lambda) {
            const n = X.length;
            const coeffs = Array(degree + 1).fill(0);

            const lr = 0.001;
            const iterations = 1000;

            for (let iter = 0; iter < iterations; iter++) {
                const gradients = Array(degree + 1).fill(0);

                for (let i = 0; i < n; i++) {
                    let pred = 0;
                    for (let j = 0; j <= degree; j++) {
                        pred += coeffs[j] * Math.pow(X[i], j);
                    }
                    const error = pred - y[i];

                    for (let j = 0; j <= degree; j++) {
                        gradients[j] += error * Math.pow(X[i], j);
                    }
                }

                // æ·»åŠ L2æ­£åˆ™åŒ–é¡¹
                for (let j = 1; j <= degree; j++) {  // ä¸æƒ©ç½šæˆªè·é¡¹
                    gradients[j] += lambda * coeffs[j];
                }

                for (let j = 0; j <= degree; j++) {
                    coeffs[j] -= lr * gradients[j] / n;
                }
            }

            return coeffs;
        }

        function predict(x, coeffs) {
            let y = 0;
            for (let i = 0; i < coeffs.length; i++) {
                y += coeffs[i] * Math.pow(x, i);
            }
            return y;
        }

        function safeFinite(value, fallback = 0) {
            return Number.isFinite(value) ? value : fallback;
        }

        function build2DLayout(layout) {
            const axisBase = {
                gridcolor: '#dbe6f8',
                zerolinecolor: '#c5d6f3',
                linecolor: '#8ea9de',
                tickcolor: '#8ea9de',
                ticks: 'outside',
                automargin: true,
            };

            return {
                paper_bgcolor: '#f8fbff',
                plot_bgcolor: '#f8fbff',
                font: { color: '#0f172a' },
                margin: { t: 56, r: 24, b: 52, l: 60 },
                ...layout,
                xaxis: {
                    ...axisBase,
                    ...(layout?.xaxis || {}),
                },
                yaxis: {
                    ...axisBase,
                    ...(layout?.yaxis || {}),
                },
            };
        }


        function updateVisualization(lambda) {
            document.getElementById('lambdaValue').textContent = lambda.toFixed(1);

            const degree = 8;
            const coeffs = ridgeFit(data.X, data.y, degree, lambda);

            // æ‹Ÿåˆæ›²çº¿
            const xRange = [];
            const yPred = [];
            for (let x = -2; x <= 2; x += 0.05) {
                xRange.push(x);
                yPred.push(safeFinite(predict(x, coeffs), null));
            }

            const trace1 = {
                x: data.X,
                y: data.y,
                mode: 'markers',
                type: 'scatter',
                name: 'è®­ç»ƒæ•°æ®',
                marker: { size: 10, color: '#1d4ed8' }
            };

            const trace2 = {
                x: xRange,
                y: yPred,
                mode: 'lines',
                type: 'scatter',
                name: `æ‹Ÿåˆæ›²çº¿ (Î»=${lambda.toFixed(1)})`,
                line: { color: '#f44336', width: 3 }
            };

            Plotly.newPlot('fittingChart', [trace1, trace2], build2DLayout({
                title: `Ridgeå›å½’æ‹Ÿåˆæ•ˆæœ (Î»=${lambda.toFixed(1)})`,
                xaxis: { title: 'x' },
                yaxis: { title: 'y' },
                height: 400
            }));

            // æƒé‡å¯è§†åŒ–
            const trace3 = {
                x: Array.from({ length: degree + 1 }, (_, i) => `w${i}`),
                y: coeffs,
                type: 'bar',
                marker: {
                    color: coeffs.map(c => safeFinite(Math.abs(c), 0)),
                    colorscale: 'YlGnBu',
                    showscale: true,
                    colorbar: { title: '|æƒé‡|' }
                },
                text: coeffs.map(c => safeFinite(c, 0).toFixed(3)),
                textposition: 'outside'
            };

            Plotly.newPlot('weightsChart', [trace3], build2DLayout({
                title: 'æ¨¡å‹æƒé‡åˆ†å¸ƒ',
                xaxis: { title: 'æƒé‡å‚æ•°' },
                yaxis: { title: 'æƒé‡å€¼' },
                height: 350
            }));
        }

        function animateRegularization() {
            if (animationInterval) return;

            currentLambda = 0;
            document.getElementById('lambda').value = 0;

            animationInterval = setInterval(() => {
                currentLambda += 0.2;
                if (currentLambda > 10) {
                    pauseAnimation();
                    return;
                }

                document.getElementById('lambda').value = currentLambda;
                updateVisualization(currentLambda);
            }, 300);
        }

        function pauseAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
        }

        function resetAnimation() {
            pauseAnimation();
            currentLambda = 0;
            document.getElementById('lambda').value = 0;
            updateVisualization(0);
        }

        // æ‰‹åŠ¨æ»‘å—æ§åˆ¶
        document.getElementById('lambda').addEventListener('input', (e) => {
            pauseAnimation();
            updateVisualization(parseFloat(e.target.value));
        });

        // åˆå§‹åŒ–
        updateVisualization(0);
    </script>

<script>
(function () {
  const sendHeight = () => {
    if (window.parent === window) return;
    const body = document.body;
    const root = document.documentElement;
    const height = Math.max(
      body ? body.scrollHeight : 0,
      body ? body.offsetHeight : 0,
      root ? root.scrollHeight : 0,
      root ? root.offsetHeight : 0
    );
    window.parent.postMessage({ type: 'iframe-height', height }, '*');
  };

  window.addEventListener('load', sendHeight);
  window.addEventListener('resize', sendHeight);

  if ('ResizeObserver' in window) {
    const observer = new ResizeObserver(sendHeight);
    if (document.body) observer.observe(document.body);
    if (document.documentElement) observer.observe(document.documentElement);
  }

  requestAnimationFrame(sendHeight);
  setTimeout(sendHeight, 250);
  setTimeout(sendHeight, 1000);
})();
</script>
</body>
</html>
