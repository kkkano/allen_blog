<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¥ç»ç½‘ç»œç»“æ„å¯è§†åŒ–</title>
  <style>
    :root {
      --bg: #f4f7ff;
      --card: #ffffff;
      --border: #d8e2ff;
      --text: #1f2a44;
      --sub: #5f6f97;
      --line: #a6b8ec;
      --line-active: #4f6fe6;
      --in: #4caf50;
      --h1: #2f8df8;
      --h2: #ff9800;
      --out: #f44336;
      --chip: #eef3ff;
      --btn-a: #5d78e8;
      --btn-b: #6f58c9;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      background: linear-gradient(135deg, #dfe8ff 0%, #edf2ff 100%);
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      min-height: 0;
      color: var(--text);
    }

    .wrap {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 30px rgba(75, 103, 196, 0.14);
      overflow: hidden;
    }

    .head {
      text-align: center;
      margin-bottom: 10px;
    }

    .head h1 {
      margin: 0;
      font-size: 1.8rem;
      color: #2d3b63;
      letter-spacing: 0.2px;
    }

    .head p {
      margin: 6px 0 0;
      color: var(--sub);
      font-size: 0.92rem;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 10px;
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fafcff;
      padding: 10px;
    }

    .network-shell {
      position: relative;
      overflow: hidden;
    }

    #networkCanvas {
      width: 100%;
      height: auto;
      display: block;
      border: 1px solid #d0dcff;
      border-radius: 10px;
      background: linear-gradient(180deg, #f8fbff 0%, #f2f7ff 100%);
    }

    .legend {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #d8e2ff;
      background: var(--chip);
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.78rem;
      color: #3d4d75;
      white-space: nowrap;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #2a3654;
    }

    .controls {
      display: grid;
      gap: 8px;
    }

    .controls h3 {
      margin: 0;
      color: #30416c;
      font-size: 0.95rem;
    }

    .line {
      display: grid;
      gap: 5px;
    }

    .line label {
      display: flex;
      justify-content: space-between;
      color: #465a89;
      font-size: 0.8rem;
      gap: 8px;
    }

    .val {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      color: #2b3f79;
      font-weight: 600;
    }

    input[type='range'] {
      width: 100%;
      accent-color: #607ee6;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      background: linear-gradient(135deg, var(--btn-a), var(--btn-b));
      color: #fff;
      font-size: 0.84rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(97, 122, 220, 0.3);
    }

    button.secondary {
      background: linear-gradient(135deg, #8194cb, #6f80b4);
    }

    .status {
      margin-top: 6px;
      font-size: 0.82rem;
      color: #4a5d8f;
      min-height: 1.2rem;
    }

    .stats {
      border: 1px solid #d8e2ff;
      border-radius: 10px;
      background: #f6f9ff;
      padding: 8px;
      font-size: 0.82rem;
      line-height: 1.5;
      color: #3f537f;
    }

    .stats strong {
      color: #2c3f6d;
    }

    @media (max-width: 940px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .head h1 {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 560px) {
      body { padding: 10px; }
      .wrap { padding: 10px; }
      .head h1 { font-size: 1.28rem; }
      .btn-row button { flex: 1 1 auto; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1>ğŸ§  ç¥ç»ç½‘ç»œç»“æ„å¯è§†åŒ–</h1>
      <p>æ‰‹å†™æ•°å­— 0/1 è¯†åˆ«ï¼šè¾“å…¥å±‚(400) â†’ éšè—å±‚1(25) â†’ éšè—å±‚2(15) â†’ è¾“å‡ºå±‚(1)</p>
    </div>

    <div class="layout">
      <div class="panel network-shell">
        <canvas id="networkCanvas" width="860" height="420"></canvas>

        <div class="legend">
          <span class="chip"><span class="dot" style="background:#4caf50"></span>è¾“å…¥å±‚ï¼ˆ400ï¼‰</span>
          <span class="chip"><span class="dot" style="background:#2f8df8"></span>éšè—å±‚1ï¼ˆ25ï¼‰</span>
          <span class="chip"><span class="dot" style="background:#ff9800"></span>éšè—å±‚2ï¼ˆ15ï¼‰</span>
          <span class="chip"><span class="dot" style="background:#f44336"></span>è¾“å‡ºå±‚ï¼ˆ1ï¼‰</span>
        </div>
      </div>

      <div class="panel controls">
        <h3>äº¤äº’æ§åˆ¶</h3>

        <div class="line">
          <label>çº¿æ¡å¯†åº¦ <span id="densityVal" class="val">0.80</span></label>
          <input id="density" type="range" min="0.3" max="1" step="0.05" value="0.8" />
        </div>

        <div class="line">
          <label>æ¿€æ´»å¼ºåº¦ <span id="activationVal" class="val">0.70</span></label>
          <input id="activation" type="range" min="0.2" max="1" step="0.05" value="0.7" />
        </div>

        <div class="line">
          <label>ä¼ æ’­é€Ÿåº¦ <span id="speedVal" class="val">1.00</span></label>
          <input id="speed" type="range" min="0.5" max="2" step="0.1" value="1.0" />
        </div>

        <div class="btn-row">
          <button id="forwardBtn">â–¶ å‰å‘ä¼ æ’­</button>
          <button id="autoBtn">ğŸ”„ è‡ªåŠ¨æ¼”ç¤º</button>
          <button id="resetBtn" class="secondary">â†º é‡ç½®</button>
        </div>

        <div id="status" class="status">å‡†å¤‡å°±ç»ªï¼šç‚¹å‡»â€œå‰å‘ä¼ æ’­â€æŸ¥çœ‹ä¿¡å·ä»å·¦åˆ°å³æµåŠ¨ã€‚</div>

        <div class="stats">
          <strong>å‚æ•°è§„æ¨¡ï¼ˆçœŸå®å±‚å®½ï¼‰</strong><br />
          ç¬¬1å±‚ï¼š400 Ã— 25 + 25 = <strong>10,025</strong><br />
          ç¬¬2å±‚ï¼š25 Ã— 15 + 15 = <strong>390</strong><br />
          è¾“å‡ºå±‚ï¼š15 Ã— 1 + 1 = <strong>16</strong><br />
          æ€»å‚æ•°ï¼š<strong>10,431</strong>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const canvas = document.getElementById('networkCanvas');
      const context = canvas.getContext('2d');

      const controls = {
        density: document.getElementById('density'),
        activation: document.getElementById('activation'),
        speed: document.getElementById('speed'),
      };

      const labels = {
        density: document.getElementById('densityVal'),
        activation: document.getElementById('activationVal'),
        speed: document.getElementById('speedVal'),
      };

      const forwardBtn = document.getElementById('forwardBtn');
      const autoBtn = document.getElementById('autoBtn');
      const resetBtn = document.getElementById('resetBtn');
      const statusEl = document.getElementById('status');

      const layers = [
        { name: 'è¾“å…¥å±‚\n(400)', x: 95, shown: 10, color: '#4caf50', real: 400 },
        { name: 'éšè—å±‚1\n(25)', x: 305, shown: 8, color: '#2f8df8', real: 25 },
        { name: 'éšè—å±‚2\n(15)', x: 520, shown: 6, color: '#ff9800', real: 15 },
        { name: 'è¾“å‡ºå±‚\n(1)', x: 740, shown: 1, color: '#f44336', real: 1 },
      ];

      const state = {
        density: Number(controls.density.value),
        activation: Number(controls.activation.value),
        speed: Number(controls.speed.value),
        auto: false,
        phase: -1,
      };

      let animationTimer = null;
      let autoTimer = null;

      function syncLabels() {
        labels.density.textContent = state.density.toFixed(2);
        labels.activation.textContent = state.activation.toFixed(2);
        labels.speed.textContent = state.speed.toFixed(2);
      }

      function neuronY(index, total) {
        const top = 90;
        const height = 270;
        if (total === 1) return top + height / 2;
        const gap = height / (total - 1);
        return top + gap * index;
      }

      function drawLayerTitles() {
        context.fillStyle = '#2a385d';
        context.textAlign = 'center';
        context.font = 'bold 18px Segoe UI';
        layers.forEach((layer) => {
          const lines = layer.name.split('\n');
          context.fillText(lines[0], layer.x, 30);
          context.fillStyle = '#4a5f8f';
          context.font = 'bold 16px Segoe UI';
          context.fillText(lines[1], layer.x, 53);
          context.fillStyle = '#2a385d';
          context.font = 'bold 18px Segoe UI';
        });
      }

      function shouldDrawConnection(fromIndex, toIndex) {
        const key = (fromIndex + 1) * 131 + (toIndex + 1) * 197;
        const normalized = (Math.sin(key) + 1) / 2;
        return normalized <= state.density;
      }

      function drawConnections() {
        for (let layerIndex = 0; layerIndex < layers.length - 1; layerIndex += 1) {
          const current = layers[layerIndex];
          const next = layers[layerIndex + 1];
          const activeBand = state.phase === layerIndex;

          for (let i = 0; i < current.shown; i += 1) {
            const fromY = neuronY(i, current.shown);
            for (let j = 0; j < next.shown; j += 1) {
              if (!shouldDrawConnection(i + layerIndex * 10, j + layerIndex * 20)) {
                continue;
              }

              const toY = neuronY(j, next.shown);
              context.beginPath();
              context.moveTo(current.x + 14, fromY);
              context.lineTo(next.x - 14, toY);

              if (activeBand) {
                context.strokeStyle = `rgba(79, 111, 230, ${0.35 + state.activation * 0.45})`;
                context.lineWidth = 1.8;
              } else {
                context.strokeStyle = 'rgba(150, 171, 231, 0.52)';
                context.lineWidth = 1.05;
              }
              context.stroke();
            }
          }
        }
      }

      function drawNeurons() {
        layers.forEach((layer, layerIndex) => {
          for (let i = 0; i < layer.shown; i += 1) {
            const y = neuronY(i, layer.shown);
            const active = state.phase >= layerIndex;

            context.beginPath();
            context.arc(layer.x, y, 14, 0, Math.PI * 2);
            context.fillStyle = active ? layer.color : '#f0f4ff';
            context.fill();

            context.strokeStyle = layer.color;
            context.lineWidth = 2;
            context.stroke();

            if (active) {
              context.shadowColor = layer.color;
              context.shadowBlur = 10 + state.activation * 10;
              context.beginPath();
              context.arc(layer.x, y, 14, 0, Math.PI * 2);
              context.strokeStyle = `rgba(255,255,255,${0.2 + state.activation * 0.3})`;
              context.lineWidth = 1;
              context.stroke();
              context.shadowBlur = 0;
            }
          }
        });
      }

      function drawCountHints() {
        context.fillStyle = '#6c80b1';
        context.font = '12px Segoe UI';
        context.textAlign = 'center';
        layers.forEach((layer) => {
          if (layer.real !== layer.shown) {
            context.fillText(`ç¤ºæ„ ${layer.shown}/${layer.real}`, layer.x, 390);
          }
        });
      }

      function render() {
        context.clearRect(0, 0, canvas.width, canvas.height);
        drawLayerTitles();
        drawConnections();
        drawNeurons();
        drawCountHints();
        reportHeight();
      }

      function stopForward() {
        if (animationTimer) {
          clearInterval(animationTimer);
          animationTimer = null;
        }
      }

      function startForward() {
        if (animationTimer) {
          return;
        }
        stopAutoPlay();
        state.phase = -1;
        statusEl.textContent = 'å‰å‘ä¼ æ’­ä¸­ï¼šä¿¡å·ä»è¾“å…¥å±‚ä¾æ¬¡æµå‘éšè—å±‚ä¸è¾“å‡ºå±‚ã€‚';
        render();

        const interval = Math.max(220, 650 / Math.max(0.5, state.speed));
        animationTimer = setInterval(() => {
          state.phase += 1;
          render();

          if (state.phase >= layers.length - 1) {
            stopForward();
            statusEl.textContent = 'å‰å‘ä¼ æ’­å®Œæˆï¼šè¾“å‡ºå±‚å·²å¾—åˆ°åˆ†ç±»æ¦‚ç‡ã€‚';
          }
        }, interval);
      }

      function startAutoPlay() {
        if (state.auto) {
          stopAutoPlay();
          return;
        }

        stopForward();
        state.auto = true;
        autoBtn.textContent = 'â¸ åœæ­¢è‡ªåŠ¨æ¼”ç¤º';
        statusEl.textContent = 'è‡ªåŠ¨æ¼”ç¤ºä¸­ï¼šå¾ªç¯å±•ç¤ºå‰å‘ä¼ æ’­è¿‡ç¨‹ã€‚';

        const cycle = () => {
          state.phase = -1;
          render();

          const interval = Math.max(180, 530 / Math.max(0.5, state.speed));
          let localTimer = setInterval(() => {
            state.phase += 1;
            render();
            if (state.phase >= layers.length - 1) {
              clearInterval(localTimer);
            }
          }, interval);
        };

        cycle();
        autoTimer = setInterval(cycle, Math.max(1400, 3000 / Math.max(0.5, state.speed)));
      }

      function stopAutoPlay() {
        if (!state.auto && !autoTimer) {
          return;
        }
        state.auto = false;
        if (autoTimer) {
          clearInterval(autoTimer);
          autoTimer = null;
        }
        autoBtn.textContent = 'ğŸ”„ è‡ªåŠ¨æ¼”ç¤º';
      }

      function resetAll() {
        stopForward();
        stopAutoPlay();
        state.phase = -1;
        statusEl.textContent = 'å‡†å¤‡å°±ç»ªï¼šç‚¹å‡»â€œå‰å‘ä¼ æ’­â€æŸ¥çœ‹ä¿¡å·ä»å·¦åˆ°å³æµåŠ¨ã€‚';
        render();
      }

      function bind() {
        forwardBtn.addEventListener('click', startForward);
        autoBtn.addEventListener('click', startAutoPlay);
        resetBtn.addEventListener('click', resetAll);

        Object.entries(controls).forEach(([key, element]) => {
          element.addEventListener('input', () => {
            state[key] = Number(element.value);
            syncLabels();
            render();
          });
        });

        window.addEventListener('resize', reportHeight, { passive: true });
        if ('ResizeObserver' in window) {
          const observer = new ResizeObserver(reportHeight);
          observer.observe(document.body);
          observer.observe(document.documentElement);
        }
      }

      function reportHeight() {
        if (window.parent === window) return;
        const body = document.body;
        const root = document.documentElement;
        const h = Math.max(
          body ? body.scrollHeight : 0,
          body ? body.offsetHeight : 0,
          root ? root.scrollHeight : 0,
          root ? root.offsetHeight : 0
        );
        window.parent.postMessage({ type: 'iframe-height', height: h }, '*');
      }

      function init() {
        syncLabels();
        bind();
        render();
        setTimeout(reportHeight, 120);
        setTimeout(reportHeight, 500);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
