---
title: 'LangGraph Reflection Agents å®Œå…¨æŒ‡å—ï¼šä»åŸç†åˆ°å®æˆ˜'
date: '2025-12-25'
tags: ['LangChain', 'LangGraph', 'AI Agent', 'Reflection', 'LLM']
draft: false
summary: 'æ·±å…¥è§£æ LangGraph ä¸­çš„ Reflection Agents æŠ€æœ¯ï¼Œæ¶µç›– Basic Reflectionã€Reflexionã€LATS ä¸‰ç§æ ¸å¿ƒæ–¹æ³•ï¼Œä»¥åŠä¸ ReAct çš„å¯¹æ¯”åˆ†æã€‚åŒ…å«å®Œæ•´ä»£ç ç¤ºä¾‹å’Œå®æˆ˜æŒ‡å—ã€‚'
authors: ['allen']
---

## ğŸš€ Reflection æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå€¼å¾—ç”¨ï¼Ÿ

Reflection Agents çš„æ ¸å¿ƒæ€æƒ³æ˜¯è®©æ¨¡å‹åœ¨â€œç”Ÿæˆä¹‹åå†è‡ªæˆ‘æ‰¹è¯„å’Œæ”¹å†™â€ï¼Œé€šè¿‡å¤šè½®è¿­ä»£æŠŠç­”æ¡ˆä»â€œèƒ½ç”¨â€æå‡åˆ°â€œæ›´å¥½â€ã€‚

<IframeEmbed
  src="/visualizations/langgraph-reflection-loop.html"
  minHeight={760}
  title="LangGraph Reflection Loop Visualizer"
/>

ä½ å¯ä»¥å…ˆçœ‹ä¸‹é¢çš„å¯è§†åŒ–ï¼šæ¯ä¸€è½®éƒ½ä¼šå¢åŠ  Token æ¶ˆè€—å’Œå»¶è¿Ÿï¼Œä½†é€šå¸¸èƒ½æ¢æ¥æ›´é«˜çš„è´¨é‡ä¸æ›´ç¨³çš„æ¨ç†é“¾è·¯ã€‚

# LangGraph Reflection Agents å®Œå…¨æŒ‡å—

> **è®© AI å­¦ä¼š"ä¸‰æ€è€Œåè¡Œ"** â€”â€” é€šè¿‡è‡ªæˆ‘åæ€æœºåˆ¶ï¼Œæ˜¾è‘—æå‡ LLM è¾“å‡ºè´¨é‡

## ğŸ“š å‰è¨€

åœ¨ä½¿ç”¨ LLM æ—¶ï¼Œä½ æ˜¯å¦é‡åˆ°è¿‡è¿™äº›é—®é¢˜ï¼Ÿ

- ç”Ÿæˆçš„å†…å®¹è´¨é‡å‚å·®ä¸é½
- å¤æ‚ä»»åŠ¡å®¹æ˜“å‡ºé”™ä¸”æ— æ³•è‡ªæˆ‘çº æ­£
- ç¼ºä¹å¯¹è¾“å‡ºç»“æœçš„éªŒè¯æœºåˆ¶

**Reflection Agentsï¼ˆåæ€ä»£ç†ï¼‰** æ­£æ˜¯è§£å†³è¿™äº›é—®é¢˜çš„å…³é”®æŠ€æœ¯ã€‚å®ƒè®© LLM å…·å¤‡"è‡ªæˆ‘å®¡è§†"çš„èƒ½åŠ›ï¼Œé€šè¿‡è¿­ä»£æ”¹è¿›è¾“å‡ºè´¨é‡ã€‚

æœ¬æ–‡åŸºäº LangGraph å®˜æ–¹æ–‡æ¡£ [<sup>1</sup>](https://langchain-ai.github.io/langgraph/) å’Œ LangChain åšå®¢ [<sup>2</sup>](https://blog.langchain.com/reflection-agents/)ï¼Œç³»ç»Ÿæ¢³ç† Reflection Agents çš„æ ¸å¿ƒæ¦‚å¿µä¸å®ç°æ–¹æ³•ã€‚

---

## ğŸ¯ ä»€ä¹ˆæ˜¯ Reflection Agentsï¼Ÿ

### æ ¸å¿ƒæ€æƒ³

Reflection Agents çš„çµæ„Ÿæ¥æºäºè®¤çŸ¥å¿ƒç†å­¦ä¸­çš„ **åŒç³»ç»Ÿç†è®º**ï¼š

```mermaid
graph LR
    subgraph ä¼ ç»Ÿæ–¹å¼
        A[ç”¨æˆ·è¾“å…¥] --> B[LLM ç›´æ¥è¾“å‡º]
    end

    subgraph Reflectionæ–¹å¼
        C[ç”¨æˆ·è¾“å…¥] --> D[System 1: å¿«é€Ÿç”Ÿæˆ]
        D --> E[System 2: åæ€æ”¹è¿›]
        E --> F[é«˜è´¨é‡è¾“å‡º]
        E -.->|è¿­ä»£| D
    end

    style D fill:#ffcccc
    style E fill:#ccffcc
    style F fill:#ccccff
```

| ç³»ç»Ÿ         | ç‰¹ç‚¹                 | å¯¹åº”é˜¶æ®µ |
| :----------- | :------------------- | :------- |
| **System 1** | å¿«é€Ÿã€ç›´è§‰ã€è‡ªåŠ¨åŒ–   | åˆå§‹ç”Ÿæˆ |
| **System 2** | æ…¢é€Ÿã€åˆ†æã€æ·±æ€ç†Ÿè™‘ | åæ€æ”¹è¿› |

### æ ¸å¿ƒæƒè¡¡

> ğŸ’¡ **æœ¬è´¨**ï¼šç”¨é¢å¤–çš„è®¡ç®—æ—¶é—´æ¢å–æ›´é«˜çš„è¾“å‡ºè´¨é‡

| ä¼˜åŠ¿                | ä»£ä»·              |
| :------------------ | :---------------- |
| âœ… è¾“å‡ºè´¨é‡æ˜¾è‘—æå‡ | â±ï¸ å“åº”å»¶è¿Ÿå¢åŠ    |
| âœ… é”™è¯¯ç‡é™ä½       | ğŸ’° Token æ¶ˆè€—å¢åŠ  |
| âœ… é€‚åˆå¤æ‚æ¨ç†ä»»åŠ¡ | ğŸ”„ éœ€è¦å¤šè½®è¿­ä»£   |

**é€‚ç”¨åœºæ™¯**ï¼šè´¨é‡ä¼˜å…ˆçš„éå®æ—¶ä»»åŠ¡ï¼Œå¦‚å†…å®¹åˆ›ä½œã€ä»£ç ç”Ÿæˆã€å¤æ‚åˆ†æç­‰ã€‚

---

## ğŸ”§ ä¸‰ç§ Reflection æŠ€æœ¯è¯¦è§£

LangGraph æä¾›äº†ä¸‰ç§ç”±ç®€åˆ°ç¹çš„ Reflection å®ç°æ–¹å¼ï¼š

| æŠ€æœ¯                 | å¤æ‚åº¦ | æ ¸å¿ƒç‰¹ç‚¹             | é€‚ç”¨åœºæ™¯           |
| :------------------- | :----- | :------------------- | :----------------- |
| **Basic Reflection** | â­     | ç®€å•çš„ç”Ÿæˆ-åæ€å¾ªç¯  | å¿«é€ŸåŸå‹ã€ç®€å•ä»»åŠ¡ |
| **Reflexion**        | â­â­   | å¸¦å¤–éƒ¨å·¥å…·éªŒè¯çš„åæ€ | éœ€è¦äº‹å®å‡†ç¡®çš„ä»»åŠ¡ |
| **LATS**             | â­â­â­ | æ ‘æœç´¢ + åæ€ + å›æº¯ | é«˜å‡†ç¡®ç‡å¤æ‚æ¨ç†   |

---

### 1ï¸âƒ£ Basic Reflectionï¼ˆåŸºç¡€åæ€ï¼‰

#### å·¥ä½œåŸç†

æœ€ç®€å•çš„åæ€æ¨¡å¼ï¼š**ç”Ÿæˆ â†’ åæ€ â†’ æ”¹è¿› â†’ å¾ªç¯**

```mermaid
graph TD
    A[ğŸ‘¤ ç”¨æˆ·è¯·æ±‚] --> B[ğŸ¤– Generator: ç”Ÿæˆå›ç­”]
    B --> C{ğŸ”„ è¾¾åˆ°è¿­ä»£ä¸Šé™?}
    C -->|å¦| D[ğŸ” Reflector: æ‰¹è¯„/å»ºè®®]
    D --> B
    C -->|æ˜¯| E[âœ… è¾“å‡ºæœ€ç»ˆç­”æ¡ˆ]

    style A fill:#e1f5fe
    style B fill:#fff3e0
    style D fill:#f3e5f5
    style E fill:#e8f5e9
```

#### æ ¸å¿ƒç‰¹ç‚¹

| ä¼˜ç‚¹                      | ç¼ºç‚¹                        |
| :------------------------ | :-------------------------- |
| âœ… å®ç°ç®€å•ï¼Œæ˜“äºç†è§£     | âŒ åæ€æ— å¤–éƒ¨ä¾æ®ï¼Œå¯èƒ½ä¸»è§‚ |
| âœ… å¤šè½®æ”¹è¿›æœºä¼š           | âŒ å¯èƒ½é™·å…¥"è‡ªæˆ‘æ„Ÿè§‰è‰¯å¥½"   |
| âœ… å¯ä½¿ç”¨ä¸åŒè§’è‰²è¿›è¡Œåæ€ | âŒ æ— æ³•éªŒè¯è¾“å‡ºæ­£ç¡®æ€§       |

#### LangGraph å®ç°

```python
from typing import Annotated
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_openai import ChatOpenAI
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from typing_extensions import TypedDict

# å®šä¹‰çŠ¶æ€
class State(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]

# åˆå§‹åŒ– LLM
llm = ChatOpenAI(model="gpt-4o-mini", temperature=0.7)

# ç”Ÿæˆå™¨ Prompt
generate_prompt = ChatPromptTemplate.from_messages([
    ("system", """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å†…å®¹åˆ›ä½œè€…ã€‚
è¯·æ ¹æ®ç”¨æˆ·çš„è¯·æ±‚ç”Ÿæˆé«˜è´¨é‡çš„å†…å®¹ã€‚
å¦‚æœæ”¶åˆ°ä¿®æ”¹å»ºè®®ï¼Œè¯·æ®æ­¤æ”¹è¿›ä½ çš„è¾“å‡ºã€‚"""),
    MessagesPlaceholder(variable_name="messages"),
])

# åæ€å™¨ Prompt
reflect_prompt = ChatPromptTemplate.from_messages([
    ("system", """ä½ æ˜¯ä¸€ä½ä¸¥æ ¼çš„å†…å®¹å®¡æ ¸ä¸“å®¶ã€‚
è¯·å¯¹ä»¥ä¸‹å†…å®¹è¿›è¡Œæ‰¹åˆ¤æ€§åˆ†æï¼ŒæŒ‡å‡ºï¼š
1. å†…å®¹çš„ä¼˜ç‚¹
2. å­˜åœ¨çš„é—®é¢˜æˆ–ä¸è¶³
3. å…·ä½“çš„æ”¹è¿›å»ºè®®

è¯·ç›´æ¥ç»™å‡ºå»ºè®¾æ€§çš„åé¦ˆï¼Œä¸è¦å®¢å¥—ã€‚"""),
    MessagesPlaceholder(variable_name="messages"),
])

# åˆ›å»ºé“¾
generate_chain = generate_prompt | llm
reflect_chain = reflect_prompt | llm

# å®šä¹‰èŠ‚ç‚¹å‡½æ•°
def generation_node(state: State) -> dict:
    """ç”ŸæˆèŠ‚ç‚¹ï¼šäº§å‡ºå†…å®¹"""
    response = generate_chain.invoke({"messages": state["messages"]})
    return {"messages": [response]}

def reflection_node(state: State) -> dict:
    """åæ€èŠ‚ç‚¹ï¼šæ‰¹è¯„å¹¶ç»™å‡ºæ”¹è¿›å»ºè®®"""
    response = reflect_chain.invoke({"messages": state["messages"]})
    # å…³é”®æŠ€å·§ï¼šå°†åæ€ç»“æœä¼ªè£…æˆ HumanMessage
    # è¿™æ · LLM ä¼šæ›´é‡è§†è¿™äº›åé¦ˆ
    return {"messages": [HumanMessage(content=response.content)]}

# å®šä¹‰æ¡ä»¶è¾¹ï¼šæ§åˆ¶å¾ªç¯æ¬¡æ•°
def should_continue(state: State) -> str:
    """åˆ¤æ–­æ˜¯å¦ç»§ç»­è¿­ä»£"""
    # æ¯è½®å¾ªç¯äº§ç”Ÿ 2 æ¡æ¶ˆæ¯ï¼ˆç”Ÿæˆ + åæ€ï¼‰
    # 6 æ¡æ¶ˆæ¯ = 3 è½®è¿­ä»£
    if len(state["messages"]) > 6:
        return END
    return "reflect"

# æ„å»ºå›¾
graph_builder = StateGraph(State)

# æ·»åŠ èŠ‚ç‚¹
graph_builder.add_node("generate", generation_node)
graph_builder.add_node("reflect", reflection_node)

# æ·»åŠ è¾¹
graph_builder.add_edge(START, "generate")
graph_builder.add_conditional_edges("generate", should_continue)
graph_builder.add_edge("reflect", "generate")

# ç¼–è¯‘å›¾
graph = graph_builder.compile()
```

#### ä½¿ç”¨ç¤ºä¾‹

```python
# æ‰§è¡Œåæ€å¾ªç¯
inputs = {
    "messages": [
        HumanMessage(content="è¯·å†™ä¸€æ¡å…³äº LangChain çš„æ¨æ–‡ï¼Œè¦æ±‚ä¸“ä¸šä¸”æœ‰å¸å¼•åŠ›")
    ]
}

# è¿è¡Œå¹¶è·å–ç»“æœ
result = graph.invoke(inputs)

# è¾“å‡ºæœ€ç»ˆç»“æœ
print("=== æœ€ç»ˆè¾“å‡º ===")
print(result["messages"][-1].content)

# æŸ¥çœ‹å®Œæ•´è¿­ä»£è¿‡ç¨‹
print("\n=== è¿­ä»£è¿‡ç¨‹ ===")
for i, msg in enumerate(result["messages"]):
    role = "ç”¨æˆ·" if isinstance(msg, HumanMessage) else "AI"
    print(f"\n[{i+1}] {role}:")
    print(msg.content[:200] + "..." if len(msg.content) > 200 else msg.content)
```

> ğŸ’¡ **å…³é”®æŠ€å·§**ï¼šå°†åæ€ç»“æœåŒ…è£…æˆ `HumanMessage` è€Œé `AIMessage`ï¼Œå¯ä»¥è®© LLM æ›´é‡è§†è¿™äº›åé¦ˆï¼Œå› ä¸ºæ¨¡å‹é€šå¸¸å¯¹"ç”¨æˆ·è¾“å…¥"æ›´åŠ æ•æ„Ÿã€‚

---

### 2ï¸âƒ£ Reflexionï¼ˆå¸¦éªŒè¯çš„åæ€ï¼‰

#### è®ºæ–‡èƒŒæ™¯

> ğŸ“„ **è®ºæ–‡**ï¼šReflexion: Language Agents with Verbal Reinforcement Learning [<sup>3</sup>](https://arxiv.org/abs/2303.11366)

Reflexion åœ¨ Basic Reflection åŸºç¡€ä¸Šå¢åŠ äº† **å¤–éƒ¨å·¥å…·éªŒè¯**ï¼Œè®©åæ€æœ‰æ®å¯ä¾ã€‚

#### å·¥ä½œåŸç†

```mermaid
graph TD
    A[ğŸ“ Draft: ç”Ÿæˆåˆç¨¿ + è§„åˆ’æŸ¥è¯¢] --> B[ğŸ”§ Execute: æ‰§è¡Œå·¥å…·éªŒè¯]
    B --> C[ğŸ“Š Revise: åŸºäºè¯æ®ä¿®è®¢]
    C --> D{ğŸ”„ ç»§ç»­è¿­ä»£?}
    D -->|æ˜¯| B
    D -->|å¦| E[âœ… è¾“å‡ºæœ€ç»ˆç»“æœ]

    style A fill:#fff3e0
    style B fill:#e3f2fd
    style C fill:#f3e5f5
    style E fill:#e8f5e9
```

#### ä¸ Basic Reflection çš„åŒºåˆ«

| ç»´åº¦         | Basic Reflection | Reflexion              |
| :----------- | :--------------- | :--------------------- |
| **åæ€ä¾æ®** | LLM è‡ªæˆ‘è¯„ä¼°     | å¤–éƒ¨å·¥å…·éªŒè¯ç»“æœ       |
| **å¯é æ€§**   | å¯èƒ½ä¸»è§‚         | æœ‰è¯æ®æ”¯æ’‘             |
| **é€‚ç”¨åœºæ™¯** | åˆ›æ„ç±»ä»»åŠ¡       | äº‹å®å‡†ç¡®æ€§è¦æ±‚é«˜çš„ä»»åŠ¡ |
| **å¤æ‚åº¦**   | ä½               | ä¸­ç­‰                   |

#### LangGraph å®ç°

```python
from typing import Annotated, List
from langchain_core.messages import BaseMessage, HumanMessage, ToolMessage
from langchain_core.tools import tool
from langchain_openai import ChatOpenAI
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from langgraph.prebuilt import ToolNode
from typing_extensions import TypedDict

# å®šä¹‰å·¥å…·ï¼ˆç¤ºä¾‹ï¼šæœç´¢å·¥å…·ï¼‰
@tool
def search_tool(query: str) -> str:
    """æœç´¢ç›¸å…³ä¿¡æ¯è¿›è¡ŒéªŒè¯"""
    # å®é™…åº”ç”¨ä¸­æ¥å…¥çœŸå®æœç´¢ API
    return f"æœç´¢ç»“æœï¼šå…³äº '{query}' çš„éªŒè¯ä¿¡æ¯..."

@tool
def fact_check_tool(statement: str) -> str:
    """äº‹å®æ ¸æŸ¥å·¥å…·"""
    # å®é™…åº”ç”¨ä¸­æ¥å…¥äº‹å®æ ¸æŸ¥æœåŠ¡
    return f"æ ¸æŸ¥ç»“æœï¼š'{statement}' çš„å‡†ç¡®æ€§åˆ†æ..."

tools = [search_tool, fact_check_tool]

# å®šä¹‰çŠ¶æ€
class ReflexionState(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]
    draft: str
    search_queries: List[str]
    revision_number: int

# åˆå§‹åŒ–å¸¦å·¥å…·çš„ LLM
llm = ChatOpenAI(model="gpt-4o-mini").bind_tools(tools)

# èŠ‚ç‚¹å‡½æ•°
def draft_node(state: ReflexionState) -> dict:
    """ç”Ÿæˆåˆç¨¿å¹¶è§„åˆ’éœ€è¦éªŒè¯çš„æŸ¥è¯¢"""
    # ç”Ÿæˆåˆç¨¿çš„é€»è¾‘
    response = llm.invoke(state["messages"])
    return {
        "messages": [response],
        "draft": response.content,
        "revision_number": state.get("revision_number", 0) + 1
    }

def execute_tools_node(state: ReflexionState) -> dict:
    """æ‰§è¡Œå·¥å…·è¿›è¡ŒéªŒè¯"""
    tool_node = ToolNode(tools)
    return tool_node.invoke(state)

def revise_node(state: ReflexionState) -> dict:
    """åŸºäºå·¥å…·ç»“æœä¿®è®¢å†…å®¹"""
    revision_prompt = f"""
    åŸºäºä»¥ä¸‹éªŒè¯ç»“æœï¼Œä¿®è®¢ä½ çš„å›ç­”ï¼š

    åŸå§‹è‰ç¨¿ï¼š{state['draft']}

    è¯·æ ¹æ®å·¥å…·è¿”å›çš„ä¿¡æ¯è¿›è¡Œä¿®æ­£å’Œå®Œå–„ã€‚
    """
    response = llm.invoke(state["messages"] + [HumanMessage(content=revision_prompt)])
    return {"messages": [response], "draft": response.content}

def should_continue(state: ReflexionState) -> str:
    """åˆ¤æ–­æ˜¯å¦ç»§ç»­è¿­ä»£"""
    if state.get("revision_number", 0) >= 3:
        return END
    return "execute_tools"

# æ„å»ºå›¾
graph_builder = StateGraph(ReflexionState)

graph_builder.add_node("draft", draft_node)
graph_builder.add_node("execute_tools", execute_tools_node)
graph_builder.add_node("revise", revise_node)

graph_builder.add_edge(START, "draft")
graph_builder.add_edge("draft", "execute_tools")
graph_builder.add_edge("execute_tools", "revise")
graph_builder.add_conditional_edges("revise", should_continue)

graph = graph_builder.compile()
```

#### æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿                | è¯´æ˜             |
| :------------------ | :--------------- |
| âœ… å¤–éƒ¨æ•°æ®æ”¯æ’‘åæ€ | ä¸å†æ˜¯"è‡ªè¯´è‡ªè¯" |
| âœ… å¯ç”Ÿæˆå¼•ç”¨/æ¥æº  | å¢å¼ºå¯ä¿¡åº¦       |
| âœ… æ”¹è¿›æ›´å¯é        | åŸºäºäº‹å®è€ŒéçŒœæµ‹ |

#### å±€é™æ€§

| å±€é™            | è¯´æ˜                 |
| :-------------- | :------------------- |
| âŒ å•è·¯å¾„æ‰§è¡Œ   | æ—©æœŸé”™è¯¯å¯èƒ½å½±å“åç»­ |
| âŒ æ— å›æº¯æœºåˆ¶   | æ— æ³•æ’¤é”€é”™è¯¯å†³ç­–     |
| âŒ ä¾èµ–å·¥å…·è´¨é‡ | å·¥å…·ä¸å‡†ç¡®ä¼šå½±å“ç»“æœ |

---

### 3ï¸âƒ£ LATSï¼ˆLanguage Agent Tree Searchï¼‰

#### è®ºæ–‡èƒŒæ™¯

> ğŸ“„ **è®ºæ–‡**ï¼šLanguage Agent Tree Search Unifies Reasoning Acting and Planning in Language Models [<sup>4</sup>](https://arxiv.org/abs/2310.04406)

LATS æ˜¯ç›®å‰æœ€å¼ºå¤§çš„ Reflection æŠ€æœ¯ï¼Œç»“åˆäº† **è’™ç‰¹å¡æ´›æ ‘æœç´¢ï¼ˆMCTSï¼‰**ã€**åæ€** å’Œ **å›æº¯** æœºåˆ¶ã€‚

#### å·¥ä½œåŸç†

```mermaid
graph TD
    A[ğŸŒ³ æ ¹èŠ‚ç‚¹] --> B[1ï¸âƒ£ Select: UCTé€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹]
    B --> C[2ï¸âƒ£ Expand: ç”ŸæˆNä¸ªå€™é€‰è¡ŒåŠ¨]
    C --> D[3ï¸âƒ£ Simulate: æ‰§è¡Œè¡ŒåŠ¨]
    D --> E[4ï¸âƒ£ Reflect: åæ€å¹¶è¯„åˆ†]
    E --> F[5ï¸âƒ£ Backpropagate: å›ä¼ æ›´æ–°åˆ†æ•°]
    F --> G{æ‰¾åˆ°è§£å†³æ–¹æ¡ˆ?}
    G -->|å¦| B
    G -->|æ˜¯| H[âœ… è¾“å‡ºæœ€ä¼˜è·¯å¾„]

    style A fill:#fff9c4
    style B fill:#e3f2fd
    style C fill:#f3e5f5
    style D fill:#fff3e0
    style E fill:#e8f5e9
    style H fill:#c8e6c9
```

#### LATS äº”ä¸ªæ ¸å¿ƒæ­¥éª¤

| æ­¥éª¤ | åç§°              | è¯´æ˜                            |
| :--- | :---------------- | :------------------------------ |
| 1ï¸âƒ£   | **Select**        | ä½¿ç”¨ UCT å…¬å¼é€‰æ‹©æœ€æœ‰æ½œåŠ›çš„èŠ‚ç‚¹ |
| 2ï¸âƒ£   | **Expand**        | ä»é€‰ä¸­èŠ‚ç‚¹ç”Ÿæˆå¤šä¸ªå€™é€‰è¡ŒåŠ¨      |
| 3ï¸âƒ£   | **Simulate**      | æ‰§è¡Œè¡ŒåŠ¨ï¼Œè·å–ç»“æœ              |
| 4ï¸âƒ£   | **Reflect**       | å¯¹ç»“æœè¿›è¡Œåæ€å’Œè¯„åˆ†            |
| 5ï¸âƒ£   | **Backpropagate** | å°†è¯„åˆ†å›ä¼ æ›´æ–°æ•´æ£µæ ‘            |

#### ä¸å…¶ä»–æ–¹æ³•çš„å…¨é¢å¯¹æ¯”

| æ–¹æ³•                 | æ¨ç† | è§„åˆ’ | åæ€ | æœç´¢ | å›æº¯ |
| :------------------- | :--: | :--: | :--: | :--: | :--: |
| **ReAct**            |  âœ…  |  âŒ  |  âŒ  |  âŒ  |  âŒ  |
| **Reflexion**        |  âœ…  |  âŒ  |  âœ…  |  âŒ  |  âŒ  |
| **Tree of Thoughts** |  âœ…  |  âœ…  |  âŒ  |  âœ…  |  âŒ  |
| **Plan-and-Execute** |  âœ…  |  âœ…  |  âŒ  |  âŒ  |  âŒ  |
| **LATS**             |  âœ…  |  âœ…  |  âœ…  |  âœ…  |  âœ…  |

#### LangGraph å®ç°

```python
from typing import Optional, List, Annotated
from langchain_core.messages import BaseMessage, HumanMessage
from langchain_openai import ChatOpenAI
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from typing_extensions import TypedDict
import math

# å®šä¹‰æ ‘èŠ‚ç‚¹
class TreeNode:
    def __init__(
        self,
        messages: List[BaseMessage],
        reflection: str = "",
        parent: Optional["TreeNode"] = None
    ):
        self.messages = messages
        self.reflection = reflection
        self.parent = parent
        self.children: List["TreeNode"] = []
        self.value = 0.0  # èŠ‚ç‚¹ä»·å€¼
        self.visits = 0   # è®¿é—®æ¬¡æ•°
        self.is_solved = False
        self.depth = parent.depth + 1 if parent else 0

    @property
    def height(self) -> int:
        """è®¡ç®—æ ‘çš„é«˜åº¦"""
        if not self.children:
            return self.depth
        return max(child.height for child in self.children)

    def upper_confidence_bound(self, exploration_weight: float = 1.414) -> float:
        """è®¡ç®— UCT åˆ†æ•°ç”¨äºèŠ‚ç‚¹é€‰æ‹©"""
        if self.visits == 0:
            return float('inf')
        avg_reward = self.value / self.visits
        exploration = exploration_weight * math.sqrt(math.log(self.parent.visits) / self.visits)
        return avg_reward + exploration

    def best_child(self) -> "TreeNode":
        """é€‰æ‹©æœ€ä¼˜å­èŠ‚ç‚¹"""
        return max(self.children, key=lambda c: c.upper_confidence_bound())

    def backpropagate(self, score: float):
        """å›ä¼ åˆ†æ•°"""
        node = self
        while node:
            node.visits += 1
            node.value = (node.value * (node.visits - 1) + score) / node.visits  # Incremental average
            node = node.parent

# å®šä¹‰çŠ¶æ€
class TreeState(TypedDict):
    root: TreeNode
    input: str

# åˆå§‹åŒ– LLM
llm = ChatOpenAI(model="gpt-4o-mini")

# èŠ‚ç‚¹å‡½æ•°
def generate_initial_response(state: TreeState) -> dict:
    """ç”Ÿæˆåˆå§‹å“åº”ï¼Œåˆ›å»ºæ ¹èŠ‚ç‚¹"""
    input_message = HumanMessage(content=state["input"])
    response = llm.invoke([input_message])

    root = TreeNode(
        messages=[input_message, response],
        reflection=""
    )
    return {"root": root}

def select_node(root: TreeNode) -> TreeNode:
    """é€‰æ‹©è¦æ‰©å±•çš„èŠ‚ç‚¹"""
    node = root
    while node.children:
        node = node.best_child()
    return node

def expand_node(state: TreeState) -> dict:
    """æ‰©å±•èŠ‚ç‚¹ï¼šç”Ÿæˆå¤šä¸ªå€™é€‰æ–¹æ¡ˆ"""
    root = state["root"]
    node = select_node(root)

    # ç”Ÿæˆå¤šä¸ªå€™é€‰å“åº”
    num_candidates = 3
    for _ in range(num_candidates):
        response = llm.invoke(node.messages)

        # åæ€å¹¶è¯„åˆ†
        reflection_prompt = f"""
        è¯„ä¼°ä»¥ä¸‹å›ç­”çš„è´¨é‡ï¼ˆ1-10åˆ†ï¼‰å¹¶ç»™å‡ºæ”¹è¿›å»ºè®®ï¼š
        {response.content}
        """
        reflection = llm.invoke([HumanMessage(content=reflection_prompt)])

        # åˆ›å»ºå­èŠ‚ç‚¹
        child = TreeNode(
            messages=node.messages + [response],
            reflection=reflection.content,
            parent=node
        )
        node.children.append(child)

        # è§£æåˆ†æ•°å¹¶å›ä¼ 
        score = parse_score(reflection.content)  # è‡ªå®šä¹‰è§£æå‡½æ•°
        child.backpropagate(score)

        # æ£€æŸ¥æ˜¯å¦è§£å†³
        if score >= 8:
            child.is_solved = True

    return {"root": root}

def parse_score(reflection: str) -> float:
    """ä»åæ€ä¸­è§£æåˆ†æ•°"""
    # ç®€åŒ–å®ç°ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æ›´robustçš„è§£æ
    import re
    match = re.search(r'(\d+)/10|(\d+)åˆ†', reflection)
    if match:
        return float(match.group(1) or match.group(2)) / 10
    return 0.5

def should_loop(state: TreeState) -> str:
    """åˆ¤æ–­æ˜¯å¦ç»§ç»­æœç´¢"""
    root = state["root"]

    # æ‰¾åˆ°è§£å†³æ–¹æ¡ˆæˆ–è¾¾åˆ°æ·±åº¦é™åˆ¶
    if root.is_solved or root.height > 5:
        return END
    return "expand"

# æ„å»ºå›¾
graph_builder = StateGraph(TreeState)

graph_builder.add_node("start", generate_initial_response)
graph_builder.add_node("expand", expand_node)

graph_builder.add_edge(START, "start")
graph_builder.add_conditional_edges("start", should_loop)
graph_builder.add_conditional_edges("expand", should_loop)

graph = graph_builder.compile()
```

#### LATS é€‚ç”¨åœºæ™¯

| åœºæ™¯                | åŸå›                              |
| :------------------ | :------------------------------- |
| ğŸ§‘â€ğŸ’» **ä»£ç ç”Ÿæˆ**     | å¯é€šè¿‡æµ‹è¯•ç”¨ä¾‹éªŒè¯ï¼Œæ”¯æŒå›æº¯ä¿®æ­£ |
| ğŸ”¢ **æ•°å­¦æ¨ç†**     | å¯éªŒè¯ç­”æ¡ˆæ­£ç¡®æ€§ï¼Œæ¢ç´¢å¤šç§è§£æ³•   |
| ğŸ§© **å¤æ‚è§„åˆ’**     | éœ€è¦å¤šæ­¥éª¤æ¨ç†ï¼Œå…è®¸è¯•é”™         |
| ğŸ¯ **é«˜å‡†ç¡®ç‡ä»»åŠ¡** | è´¨é‡è¦æ±‚æé«˜ï¼Œå€¼å¾—æŠ•å…¥æ›´å¤šè®¡ç®—   |

---

## ğŸ”„ ReAct vs Reflection vs Reflexion

è¿™ä¸‰ä¸ªæ¦‚å¿µå®¹æ˜“æ··æ·†ï¼Œè®©æˆ‘ä»¬å½»åº•ç†æ¸…å®ƒä»¬çš„åŒºåˆ«ï¼š

### ä¸€å¥è¯åŒºåˆ†

| æ–¹æ³•           | ä¸€å¥è¯æè¿°                     |
| :------------- | :----------------------------- |
| **ReAct**      | è¾¹æƒ³è¾¹åšï¼Œç”¨å·¥å…·å®Œæˆä»»åŠ¡       |
| **Reflection** | åšå®Œå›å¤´æ”¹ï¼Œè‡ªæˆ‘æ‰¹è¯„æ”¹è¿›       |
| **Reflexion**  | åšå®ŒæŸ¥è¯æ®æ”¹ï¼Œç”¨å·¥å…·éªŒè¯åæ”¹è¿› |

### è¯¦ç»†å¯¹æ¯”

| ç»´åº¦         | ReAct              | Reflection               | Reflexion              |
| :----------- | :----------------- | :----------------------- | :--------------------- |
| **ç›®çš„**     | å®Œæˆä»»åŠ¡           | æé«˜è¾“å‡ºè´¨é‡             | æé«˜è´¨é‡ + éªŒè¯å‡†ç¡®æ€§  |
| **æ ¸å¿ƒåŠ¨ä½œ** | æ€è€ƒ â†’ è¡ŒåŠ¨ â†’ è§‚å¯Ÿ | ç”Ÿæˆ â†’ åæ€ â†’ æ”¹è¿›       | ç”Ÿæˆ â†’ éªŒè¯ â†’ ä¿®è®¢     |
| **å·¥å…·ä½¿ç”¨** | âœ… å¿…é¡»ä½¿ç”¨        | âŒ ä¸ä½¿ç”¨                | âœ… å¿…é¡»ä½¿ç”¨            |
| **å¤–éƒ¨éªŒè¯** | âœ… é€šè¿‡å·¥å…·è§‚å¯Ÿ    | âŒ ä»…è‡ªæˆ‘æ‰¹è¯„            | âœ… é€šè¿‡å·¥å…·éªŒè¯        |
| **ä¿®æ”¹è¾“å‡º** | âŒ åªå¾€å‰æ¨è¿›      | âœ… è¿­ä»£æ”¹è¿›              | âœ… è¿­ä»£æ”¹è¿›            |
| **å…¸å‹å¾ªç¯** | Thinkâ†’Actâ†’Observe  | Generateâ†’Reflectâ†’Improve | Generateâ†’Verifyâ†’Revise |

### æµç¨‹å¯¹æ¯”å›¾

```mermaid
graph TB
    subgraph ReAct["ğŸ”„ ReAct"]
        R1[ğŸ’­ Thought] --> R2[âš¡ Action]
        R2 --> R3[ğŸ‘ï¸ Observation]
        R3 --> R1
    end

    subgraph Reflection["ğŸª Reflection"]
        F1[ğŸ“ Generate] --> F2[ğŸ” Reflect]
        F2 --> F3[âœ¨ Improve]
        F3 --> F1
    end

    subgraph Reflexion["ğŸ”¬ Reflexion"]
        X1[ğŸ“ Generate] --> X2[ğŸ”§ Verify with Tools]
        X2 --> X3[ğŸ“Š Revise]
        X3 --> X1
    end

    style R1 fill:#e3f2fd
    style R2 fill:#fff3e0
    style R3 fill:#e8f5e9
    style F1 fill:#fff3e0
    style F2 fill:#f3e5f5
    style F3 fill:#e8f5e9
    style X1 fill:#fff3e0
    style X2 fill:#e3f2fd
    style X3 fill:#e8f5e9
```

### ç”Ÿæ´»ç±»æ¯”

| æ–¹æ³•           | ç±»æ¯”                            |
| :------------- | :------------------------------ |
| **ReAct**      | ğŸš— è¾¹çœ‹å¯¼èˆªè¾¹å¼€è½¦ï¼Œæ ¹æ®è·¯å†µè°ƒæ•´ |
| **Reflection** | ğŸ“ å†™å®Œè®ºæ–‡è‡ªå·±æ£€æŸ¥ä¿®æ”¹         |
| **Reflexion**  | ğŸ“š å†™å®Œè®ºæ–‡æŸ¥èµ„æ–™æ ¸å®åä¿®æ”¹     |

### å…³ç³»æ€»ç»“

```
Reflexion = Reflection + ReAct çš„å·¥å…·éªŒè¯èƒ½åŠ›
```

### é€‰æ‹©æŒ‡å—

| åœºæ™¯                   | æ¨èæ–¹æ³•   |
| :--------------------- | :--------- |
| éœ€è¦è°ƒç”¨ APIã€æœç´¢ä¿¡æ¯ | ReAct      |
| åˆ›æ„å†™ä½œã€å†…å®¹ä¼˜åŒ–     | Reflection |
| éœ€è¦äº‹å®å‡†ç¡®çš„å†…å®¹ç”Ÿæˆ | Reflexion  |
| å¤æ‚æ¨ç†ã€ä»£ç ç”Ÿæˆ     | LATS       |

---

## ğŸ”— ä¸‰è€…ç»“åˆä½¿ç”¨

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¸‰ç§æŠ€æœ¯å¯ä»¥æ¨¡å—åŒ–ç»„åˆï¼Œå‘æŒ¥å„è‡ªä¼˜åŠ¿ï¼š

### ç»„åˆæ–¹å¼

| ç»„åˆ                       | ä¼˜åŠ¿                   | é€‚ç”¨åœºæ™¯         |
| :------------------------- | :--------------------- | :--------------- |
| **ReAct + Reflection**     | æ‰§è¡Œååæ€æ”¹è¿›ç­–ç•¥     | å¤æ‚å¤šæ­¥éª¤ä»»åŠ¡   |
| **Reflection + Reflexion** | å…ˆè‡ªçœå†éªŒè¯           | é«˜è´¨é‡å†…å®¹ç”Ÿæˆ   |
| **ä¸‰è€…å…¨ç»“åˆ**             | æœ€å…¨é¢çš„èƒ½åŠ›           | é«˜å‡†ç¡®ç‡è¦æ±‚åœºæ™¯ |
| **LATS**                   | å…¨ç»“åˆ + æ ‘æœç´¢ + å›æº¯ | ä»£ç /æ•°å­¦æ¨ç†    |

### ç»„åˆç¤ºä¾‹æ¶æ„

```mermaid
graph TD
    A[ç”¨æˆ·è¾“å…¥] --> B[ReAct: æ”¶é›†ä¿¡æ¯]
    B --> C[Reflection: è‡ªæˆ‘è¯„ä¼°]
    C --> D{è´¨é‡è¾¾æ ‡?}
    D -->|å¦| E[Reflexion: å·¥å…·éªŒè¯]
    E --> C
    D -->|æ˜¯| F[è¾“å‡ºç»“æœ]

    style A fill:#e1f5fe
    style B fill:#fff3e0
    style C fill:#f3e5f5
    style E fill:#e3f2fd
    style F fill:#e8f5e9
```

---

## âš™ï¸ AgentExecutor vs LangGraph

### èƒŒæ™¯

åœ¨ LangChain v0.1 ä¸­ï¼Œ`AgentExecutor` æ˜¯è¿è¡Œ Agent çš„ä¸»è¦æ–¹å¼ã€‚ä½†åœ¨ v0.3 ä¸­ï¼Œå®˜æ–¹æ¨èä½¿ç”¨ **LangGraph** æ¥æ„å»ºæ›´çµæ´»çš„ Agentã€‚

> âš ï¸ **æ³¨æ„**ï¼š`AgentExecutor` ç°åœ¨è¢«æ ‡è®°ä¸º **legacyï¼ˆé—ç•™ï¼‰**ï¼Œæ–°é¡¹ç›®å»ºè®®ç›´æ¥ä½¿ç”¨ LangGraphã€‚

### æ ¸å¿ƒåŒºåˆ«

| æ–¹é¢           | AgentExecutor       | LangGraph             |
| :------------- | :------------------ | :-------------------- |
| **ä¸­é—´çŠ¶æ€**   | ğŸ”’ éšè—åœ¨å†…éƒ¨       | ğŸ‘ï¸ æ˜¾å¼å¯æŸ¥çœ‹         |
| **æ§åˆ¶æµ**     | ğŸ“¦ å›ºå®šå¾ªç¯æ¨¡å¼     | ğŸ¨ è‡ªå®šä¹‰èŠ‚ç‚¹å’Œè¾¹     |
| **æš‚åœ/æ¢å¤**  | âŒ ä¸æ”¯æŒ           | âœ… æ”¯æŒæ£€æŸ¥ç‚¹         |
| **äººå·¥ä»‹å…¥**   | ğŸ˜° å›°éš¾             | âœ… åŸç”Ÿæ”¯æŒ Interrupt |
| **è‡ªå®šä¹‰æ‰©å±•** | ğŸ”§ éœ€è¦é‡å†™å¤§é‡ä»£ç  | âœ… ç®€å•æ·»åŠ èŠ‚ç‚¹/è¾¹    |
| **è°ƒè¯•éš¾åº¦**   | ğŸ˜° é»‘ç›’ï¼Œéš¾ä»¥è°ƒè¯•   | âœ… å¯è§†åŒ–æµç¨‹å›¾       |

### ä¸ºä»€ä¹ˆé€‰æ‹© LangGraphï¼Ÿ

```mermaid
graph LR
    subgraph AgentExecutor["ğŸ“¦ AgentExecutor (Legacy)"]
        A1[è¾“å…¥] --> A2[é»‘ç›’å¾ªç¯]
        A2 --> A3[è¾“å‡º]
    end

    subgraph LangGraph["ğŸ¨ LangGraph (æ¨è)"]
        B1[è¾“å…¥] --> B2[èŠ‚ç‚¹1]
        B2 --> B3{æ¡ä»¶}
        B3 -->|è·¯å¾„A| B4[èŠ‚ç‚¹2]
        B3 -->|è·¯å¾„B| B5[èŠ‚ç‚¹3]
        B4 --> B6[è¾“å‡º]
        B5 --> B6
    end

    style A2 fill:#ffcccc
    style B2 fill:#ccffcc
    style B4 fill:#ccffcc
    style B5 fill:#ccffcc
```

### LangGraph äººå·¥ä»‹å…¥ç¤ºä¾‹

```python
from langgraph.graph import StateGraph, START, END
from langgraph.checkpoint.memory import MemorySaver

# æ„å»ºå›¾
graph_builder = StateGraph(State)
graph_builder.add_node("agent", agent_node)
graph_builder.add_node("tools", tool_node)
graph_builder.add_edge(START, "agent")
graph_builder.add_conditional_edges("agent", should_continue)
graph_builder.add_edge("tools", "agent")

# å…³é”®ï¼šæ·»åŠ æ£€æŸ¥ç‚¹å’Œä¸­æ–­ç‚¹
memory = MemorySaver()
graph = graph_builder.compile(
    checkpointer=memory,
    interrupt_before=["tools"]  # åœ¨æ‰§è¡Œå·¥å…·å‰æš‚åœï¼Œç­‰å¾…äººå·¥ç¡®è®¤
)

# æ‰§è¡Œæ—¶å¯ä»¥æš‚åœå’Œæ¢å¤
config = {"configurable": {"thread_id": "1"}}
result = graph.invoke(inputs, config)

# äººå·¥ç¡®è®¤åç»§ç»­æ‰§è¡Œ
result = graph.invoke(None, config)  # ä¼ å…¥ None ç»§ç»­æ‰§è¡Œ
```

### LangSmith vs LangGraph

| å·¥å…·          | ä½œç”¨     | ç‰¹ç‚¹                           |
| :------------ | :------- | :----------------------------- |
| **LangSmith** | å¯è§‚æµ‹æ€§ | è¿½è¸ªè°ƒç”¨ã€æŸ¥çœ‹æ—¥å¿—ã€è°ƒè¯•       |
| **LangGraph** | å¯æ§åˆ¶æ€§ | è‡ªå®šä¹‰æµç¨‹ã€çŠ¶æ€ç®¡ç†ã€äººå·¥ä»‹å…¥ |

> ğŸ’¡ **å»ºè®®**ï¼šä¸¤è€…é…åˆä½¿ç”¨æ•ˆæœæœ€ä½³ã€‚LangSmith å¸®ä½ "çœ‹æ¸…"å‘ç”Ÿäº†ä»€ä¹ˆï¼ŒLangGraph å¸®ä½ "æ§åˆ¶"æµç¨‹èµ°å‘ã€‚

---

## ğŸ› ï¸ å®Œæ•´å®æˆ˜ï¼šæ¨æ–‡ä¼˜åŒ– Agent

è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥ä¸²è”æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼šæ„å»ºä¸€ä¸ªèƒ½è‡ªæˆ‘æ”¹è¿›çš„æ¨æ–‡ç”Ÿæˆ Agentã€‚

### éœ€æ±‚åˆ†æ

- è¾“å…¥ï¼šç”¨æˆ·æä¾›çš„æ¨æ–‡è‰ç¨¿æˆ–ä¸»é¢˜
- è¾“å‡ºï¼šç»è¿‡å¤šè½®ä¼˜åŒ–çš„é«˜è´¨é‡æ¨æ–‡
- ç‰¹ç‚¹ï¼šè‡ªåŠ¨åæ€ã€è¿­ä»£æ”¹è¿›ã€å¯æ§åˆ¶è¿­ä»£æ¬¡æ•°

### å®Œæ•´ä»£ç 

```python
"""
æ¨æ–‡ä¼˜åŒ– Agent - åŸºäº LangGraph çš„ Reflection å®ç°
"""

from typing import Annotated, Literal
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_openai import ChatOpenAI
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from typing_extensions import TypedDict
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# ============ 1. å®šä¹‰çŠ¶æ€ ============
class State(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]

# ============ 2. åˆå§‹åŒ– LLM ============
llm = ChatOpenAI(model="gpt-4o-mini", temperature=0.7)

# ============ 3. å®šä¹‰ Prompts ============
# ç”Ÿæˆå™¨ Prompt
GENERATOR_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¤¾äº¤åª’ä½“å†…å®¹åˆ›ä½œè€…ï¼Œæ“…é•¿æ’°å†™å¼•äººæ³¨ç›®çš„æ¨æ–‡ã€‚

ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„è¯·æ±‚ç”Ÿæˆæˆ–ä¼˜åŒ–æ¨æ–‡ã€‚

è¦æ±‚ï¼š
1. æ¨æ–‡é•¿åº¦æ§åˆ¶åœ¨ 280 å­—ç¬¦ä»¥å†…
2. ä½¿ç”¨æ°å½“çš„ emoji å¢åŠ å¸å¼•åŠ›
3. åŒ…å«ç›¸å…³çš„ hashtag
4. è¯­è¨€ç®€æ´æœ‰åŠ›ï¼Œæœ‰å·å¬åŠ›
5. å¦‚æœæ”¶åˆ°ä¿®æ”¹å»ºè®®ï¼Œè¯·è®¤çœŸé‡‡çº³å¹¶æ”¹è¿›

è¯·ç›´æ¥è¾“å‡ºæ¨æ–‡å†…å®¹ï¼Œä¸è¦æœ‰å¤šä½™çš„è§£é‡Šã€‚"""

generate_prompt = ChatPromptTemplate.from_messages([
    ("system", GENERATOR_SYSTEM_PROMPT),
    MessagesPlaceholder(variable_name="messages"),
])

# åæ€å™¨ Prompt
REFLECTOR_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ç¤¾äº¤åª’ä½“è¿è¥ä¸“å®¶å’Œå†…å®¹å®¡æ ¸å‘˜ã€‚

ä½ çš„ä»»åŠ¡æ˜¯å¯¹æ¨æ–‡è¿›è¡Œä¸“ä¸šçš„æ‰¹åˆ¤æ€§åˆ†æã€‚

è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œè¯„ä¼°ï¼š
1. **å¸å¼•åŠ›**ï¼šæ ‡é¢˜/å¼€å¤´æ˜¯å¦æŠ“äººçœ¼çƒï¼Ÿ
2. **æ¸…æ™°åº¦**ï¼šä¿¡æ¯ä¼ è¾¾æ˜¯å¦æ¸…æ™°ï¼Ÿ
3. **è¡ŒåŠ¨å·å¬**ï¼šæ˜¯å¦æœ‰æ˜ç¡®çš„ CTAï¼Ÿ
4. **æ ¼å¼è§„èŒƒ**ï¼šé•¿åº¦ã€emojiã€hashtag ä½¿ç”¨æ˜¯å¦æ°å½“ï¼Ÿ
5. **ä¸“ä¸šæ€§**ï¼šå†…å®¹æ˜¯å¦å‡†ç¡®ã€ä¸“ä¸šï¼Ÿ

è¯·ç»™å‡ºï¼š
- å½“å‰ç‰ˆæœ¬çš„ä¼˜ç‚¹ï¼ˆ1-2 ç‚¹ï¼‰
- éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼ˆ2-3 ç‚¹å…·ä½“å»ºè®®ï¼‰
- æ”¹è¿›åçš„é¢„æœŸæ•ˆæœ

æ³¨æ„ï¼šè¯·ç›´æ¥ç»™å‡ºå»ºè®¾æ€§åé¦ˆï¼Œä¸è¦å®¢å¥—ã€‚"""

reflect_prompt = ChatPromptTemplate.from_messages([
    ("system", REFLECTOR_SYSTEM_PROMPT),
    MessagesPlaceholder(variable_name="messages"),
])

# ============ 4. åˆ›å»ºé“¾ ============
generate_chain = generate_prompt | llm
reflect_chain = reflect_prompt | llm

# ============ 5. å®šä¹‰èŠ‚ç‚¹å‡½æ•° ============
def generation_node(state: State) -> dict:
    """
    ç”ŸæˆèŠ‚ç‚¹ï¼šäº§å‡ºæ¨æ–‡å†…å®¹
    """
    print("ğŸ¤– [Generator] æ­£åœ¨ç”Ÿæˆ/ä¼˜åŒ–æ¨æ–‡...")
    response = generate_chain.invoke({"messages": state["messages"]})
    print(f"ğŸ“ ç”Ÿæˆç»“æœ: {response.content[:100]}...")
    return {"messages": [response]}

def reflection_node(state: State) -> dict:
    """
    åæ€èŠ‚ç‚¹ï¼šæ‰¹è¯„å¹¶ç»™å‡ºæ”¹è¿›å»ºè®®

    å…³é”®æŠ€å·§ï¼šå°†åæ€ç»“æœåŒ…è£…æˆ HumanMessage
    è¿™æ · LLM ä¼šæ›´é‡è§†è¿™äº›åé¦ˆ
    """
    print("ğŸ” [Reflector] æ­£åœ¨åˆ†ææ¨æ–‡è´¨é‡...")
    response = reflect_chain.invoke({"messages": state["messages"]})
    print(f"ğŸ’¡ åæ€ç»“æœ: {response.content[:100]}...")

    # å…³é”®ï¼šä¼ªè£…æˆç”¨æˆ·æ¶ˆæ¯ï¼Œå¢å¼º LLM å¯¹åé¦ˆçš„é‡è§†
    return {"messages": [HumanMessage(content=response.content)]}

# ============ 6. å®šä¹‰æ¡ä»¶è¾¹ ============
MAX_ITERATIONS = 3  # æœ€å¤§è¿­ä»£æ¬¡æ•°

def should_continue(state: State) -> Literal["reflect", "__end__"]:
    """
    åˆ¤æ–­æ˜¯å¦ç»§ç»­è¿­ä»£

    ç­–ç•¥ï¼šåŸºäºæ¶ˆæ¯æ•°é‡æ§åˆ¶
    - æ¯è½®è¿­ä»£äº§ç”Ÿ 2 æ¡æ¶ˆæ¯ï¼ˆç”Ÿæˆ + åæ€ï¼‰
    - åˆå§‹æœ‰ 1 æ¡ç”¨æˆ·æ¶ˆæ¯
    - æ‰€ä»¥ n è½®åæœ‰ 1 + 2n æ¡æ¶ˆæ¯
    """
    num_messages = len(state["messages"])
    num_iterations = (num_messages - 1) // 2

    print(f"ğŸ”„ å½“å‰è¿­ä»£è½®æ¬¡: {num_iterations}/{MAX_ITERATIONS}")

    if num_iterations >= MAX_ITERATIONS:
        print("âœ… è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œè¾“å‡ºæœ€ç»ˆç»“æœ")
        return END

    return "reflect"

# ============ 7. æ„å»ºå›¾ ============
def build_graph():
    """æ„å»º LangGraph å·¥ä½œæµ"""
    graph_builder = StateGraph(State)

    # æ·»åŠ èŠ‚ç‚¹
    graph_builder.add_node("generate", generation_node)
    graph_builder.add_node("reflect", reflection_node)

    # æ·»åŠ è¾¹
    graph_builder.add_edge(START, "generate")
    graph_builder.add_conditional_edges("generate", should_continue)
    graph_builder.add_edge("reflect", "generate")

    # ç¼–è¯‘
    return graph_builder.compile()

# ============ 8. ä¸»å‡½æ•° ============
def optimize_tweet(user_input: str) -> str:
    """
    ä¼˜åŒ–æ¨æ–‡çš„ä¸»å‡½æ•°

    Args:
        user_input: ç”¨æˆ·è¾“å…¥çš„æ¨æ–‡è‰ç¨¿æˆ–ä¸»é¢˜

    Returns:
        ä¼˜åŒ–åçš„æ¨æ–‡
    """
    graph = build_graph()

    # å‡†å¤‡è¾“å…¥
    inputs = {
        "messages": [HumanMessage(content=user_input)]
    }

    print("=" * 50)
    print("ğŸš€ å¼€å§‹æ¨æ–‡ä¼˜åŒ–æµç¨‹")
    print("=" * 50)

    # æ‰§è¡Œ
    result = graph.invoke(inputs)

    print("=" * 50)
    print("ğŸ‰ ä¼˜åŒ–å®Œæˆï¼")
    print("=" * 50)

    # è¿”å›æœ€ç»ˆç»“æœï¼ˆæœ€åä¸€æ¡ AI æ¶ˆæ¯ï¼‰
    final_message = result["messages"][-1]
    return final_message.content

def show_iteration_history(user_input: str):
    """
    å±•ç¤ºå®Œæ•´çš„è¿­ä»£å†å²
    """
    graph = build_graph()

    inputs = {
        "messages": [HumanMessage(content=user_input)]
    }

    result = graph.invoke(inputs)

    print("\n" + "=" * 60)
    print("ğŸ“œ å®Œæ•´è¿­ä»£å†å²")
    print("=" * 60)

    for i, msg in enumerate(result["messages"]):
        if isinstance(msg, HumanMessage):
            if i == 0:
                role = "ğŸ‘¤ ç”¨æˆ·è¾“å…¥"
            else:
                role = "ğŸ” åæ€å»ºè®®"
        else:
            role = "ğŸ¤– ç”Ÿæˆç»“æœ"

        print(f"\n[{i+1}] {role}")
        print("-" * 40)
        print(msg.content)

    return result

# ============ 9. è¿è¡Œç¤ºä¾‹ ============
if __name__ == "__main__":
    # ç¤ºä¾‹ 1ï¼šä¼˜åŒ–ç°æœ‰æ¨æ–‡
    draft = """
    è¯·å¸®æˆ‘ä¼˜åŒ–è¿™æ¡æ¨æ–‡ï¼š

    LangChain æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ AI æ¡†æ¶ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…æ„å»º LLM åº”ç”¨ã€‚
    """

    final_tweet = optimize_tweet(draft)
    print("\nğŸ“± æœ€ç»ˆæ¨æ–‡:")
    print(final_tweet)

    print("\n" + "=" * 60)

    # ç¤ºä¾‹ 2ï¼šä»ä¸»é¢˜ç”Ÿæˆæ¨æ–‡
    topic = "è¯·å†™ä¸€æ¡å…³äº LangGraph çš„æ¨æ–‡ï¼Œå¼ºè°ƒå®ƒåœ¨æ„å»º AI Agent æ–¹é¢çš„ä¼˜åŠ¿"

    show_iteration_history(topic)
```

### æ‰§è¡Œæµç¨‹å›¾

```mermaid
graph TD
    A[ğŸ‘¤ ç”¨æˆ·è¾“å…¥æ¨æ–‡è‰ç¨¿] --> B[ğŸ¤– Generator: ç”Ÿæˆ/ä¼˜åŒ–]
    B --> C{ğŸ”„ è¿­ä»£æ¬¡æ•° < 3?}
    C -->|æ˜¯| D[ğŸ” Reflector: åˆ†æè¯„ä¼°]
    D --> E[ğŸ’¡ ç”Ÿæˆæ”¹è¿›å»ºè®®]
    E --> B
    C -->|å¦| F[âœ… è¾“å‡ºæœ€ç»ˆæ¨æ–‡]

    style A fill:#e1f5fe
    style B fill:#fff3e0
    style D fill:#f3e5f5
    style F fill:#e8f5e9
```

### è¿è¡Œç»“æœç¤ºä¾‹

```
==================================================
ğŸš€ å¼€å§‹æ¨æ–‡ä¼˜åŒ–æµç¨‹
==================================================
ğŸ¤– [Generator] æ­£åœ¨ç”Ÿæˆ/ä¼˜åŒ–æ¨æ–‡...
ğŸ“ ç”Ÿæˆç»“æœ: ğŸš€ LangChain è®© AI å¼€å‘å˜å¾—ç®€å•ï¼æ— è®ºä½ æ˜¯æ–°æ‰‹è¿˜æ˜¯ä¸“å®¶...
ğŸ”„ å½“å‰è¿­ä»£è½®æ¬¡: 0/3
ğŸ” [Reflector] æ­£åœ¨åˆ†ææ¨æ–‡è´¨é‡...
ğŸ’¡ åæ€ç»“æœ: **ä¼˜ç‚¹**: ä½¿ç”¨äº† emojiï¼Œæœ‰ä¸€å®šå¸å¼•åŠ›...
ğŸ¤– [Generator] æ­£åœ¨ç”Ÿæˆ/ä¼˜åŒ–æ¨æ–‡...
ğŸ“ ç”Ÿæˆç»“æœ: ğŸ”¥ è¿˜åœ¨ä¸º LLM åº”ç”¨å¼€å‘å¤´ç–¼ï¼ŸLangChain æ¥æ‹¯æ•‘ä½ ï¼...
ğŸ”„ å½“å‰è¿­ä»£è½®æ¬¡: 1/3
...
==================================================
ğŸ‰ ä¼˜åŒ–å®Œæˆï¼
==================================================

ğŸ“± æœ€ç»ˆæ¨æ–‡:
ğŸ”¥ å‘Šåˆ« LLM å¼€å‘å™©æ¢¦ï¼

LangChain è®©ä½ ï¼š
âœ… å¿«é€Ÿæ„å»º AI åº”ç”¨
âœ… è½»æ¾é›†æˆå„ç§æ¨¡å‹
âœ… çµæ´»å®šåˆ¶å·¥ä½œæµ

ä»æƒ³æ³•åˆ°äº§å“ï¼Œåªéœ€å‡ è¡Œä»£ç  ğŸ’»

ç«‹å³å¼€å§‹ä½ çš„ AI ä¹‹æ—… ğŸ‘‰ langchain.com

#LangChain #AIå¼€å‘ #LLM #äººå·¥æ™ºèƒ½
```

---

## ğŸ“š å­¦ä¹ èµ„æºä¸è·¯å¾„

### å®˜æ–¹èµ„æº

| èµ„æº            | é“¾æ¥                                                                                                          | è¯´æ˜         |
| :-------------- | :------------------------------------------------------------------------------------------------------------ | :----------- |
| LangGraph æ–‡æ¡£  | LangGraph [<sup>1</sup>](https://langchain-ai.github.io/langgraph/)                                           | æœ€æƒå¨çš„å‚è€ƒ |
| Reflection æ•™ç¨‹ | Reflection Tutorial [<sup>2</sup>](https://langchain-ai.github.io/langgraph/tutorials/reflection/reflection/) | å®˜æ–¹æ•™ç¨‹     |
| Reflexion æ•™ç¨‹  | Reflexion Tutorial [<sup>3</sup>](https://langchain-ai.github.io/langgraph/tutorials/reflexion/reflexion/)    | å¸¦å·¥å…·éªŒè¯   |
| LATS æ•™ç¨‹       | LATS Tutorial [<sup>4</sup>](https://langchain-ai.github.io/langgraph/tutorials/lats/lats/)                   | æ ‘æœç´¢å®ç°   |
| LangChain åšå®¢  | Reflection Agents [<sup>5</sup>](https://blog.langchain.com/reflection-agents/)                               | æ¦‚å¿µä»‹ç»     |

### æ¨èå­¦ä¹ è·¯å¾„

```mermaid
graph LR
    A[1ï¸âƒ£ LangChain åŸºç¡€] --> B[2ï¸âƒ£ Agent æ¦‚å¿µ]
    B --> C[3ï¸âƒ£ LangGraph å…¥é—¨]
    C --> D[4ï¸âƒ£ Reflection æŠ€æœ¯]
    D --> E[5ï¸âƒ£ é«˜çº§åº”ç”¨]

    style A fill:#e3f2fd
    style B fill:#fff3e0
    style C fill:#f3e5f5
    style D fill:#e8f5e9
    style E fill:#fff9c4
```

| é˜¶æ®µ          | å†…å®¹                                     | é¢„è®¡æ—¶é—´ |
| :------------ | :--------------------------------------- | :------- |
| 1ï¸âƒ£ åŸºç¡€       | LangChain æ ¸å¿ƒç»„ä»¶ï¼ˆLLMã€Promptã€Chainï¼‰ | 1-2 å¤©   |
| 2ï¸âƒ£ Agent      | ReActã€å·¥å…·ä½¿ç”¨ã€Agent æ¶æ„              | 2-3 å¤©   |
| 3ï¸âƒ£ LangGraph  | çŠ¶æ€å›¾ã€èŠ‚ç‚¹ã€è¾¹ã€æ¡ä»¶è·¯ç”±               | 2-3 å¤©   |
| 4ï¸âƒ£ Reflection | Basic â†’ Reflexion â†’ LATS                 | 3-5 å¤©   |
| 5ï¸âƒ£ é«˜çº§       | RAG + Agentã€å¤š Agentã€éƒ¨ç½²              | æŒç»­å­¦ä¹  |

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

1. **Reflection æœ¬è´¨**ï¼šç”¨é¢å¤–è®¡ç®—æ¢å–æ›´é«˜è´¨é‡è¾“å‡º
2. **ä¸‰ç§æŠ€æœ¯**ï¼š
   - Basic Reflectionï¼šç®€å•è‡ªçœå¾ªç¯
   - Reflexionï¼šå¸¦å·¥å…·éªŒè¯çš„åæ€
   - LATSï¼šæ ‘æœç´¢ + åæ€ + å›æº¯
3. **ä¸ ReAct åŒºåˆ«**ï¼šReAct å®Œæˆä»»åŠ¡ï¼ŒReflection æå‡è´¨é‡
4. **LangGraph ä¼˜åŠ¿**ï¼šæ˜¾å¼çŠ¶æ€ã€è‡ªå®šä¹‰æµç¨‹ã€äººå·¥ä»‹å…¥

### æŠ€æœ¯é€‰æ‹©é€ŸæŸ¥è¡¨

| éœ€æ±‚               | æ¨èæŠ€æœ¯         |
| :----------------- | :--------------- |
| å¿«é€ŸåŸå‹ã€ç®€å•ä»»åŠ¡ | Basic Reflection |
| éœ€è¦äº‹å®å‡†ç¡®       | Reflexion        |
| é«˜å‡†ç¡®ç‡ã€å¤æ‚æ¨ç† | LATS             |
| ä¿¡æ¯æ”¶é›†ã€API è°ƒç”¨ | ReAct            |
| åˆ›æ„å†…å®¹ç”Ÿæˆ       | Reflection       |

### æœ€åçš„å»ºè®®

> ğŸ’¡ **å®è·µæ˜¯æœ€å¥½çš„è€å¸ˆ**ï¼šå»ºè®®ä» Basic Reflection å¼€å§‹ï¼Œé€æ­¥å°è¯•æ›´å¤æ‚çš„æŠ€æœ¯ã€‚æ¯ç§æŠ€æœ¯éƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯ï¼Œæ²¡æœ‰é“¶å¼¹ã€‚

---

## ğŸ“– å‚è€ƒæ–‡çŒ®

1. LangGraph Reflection Tutorial [<sup>2</sup>](https://langchain-ai.github.io/langgraph/tutorials/reflection/reflection/)
2. LangChain Blog: Reflection Agents [<sup>5</sup>](https://blog.langchain.com/reflection-agents/)
3. Reflexion: Language Agents with Verbal Reinforcement Learning [<sup>6</sup>](https://arxiv.org/abs/2303.11366)
4. Language Agent Tree Search Unifies Reasoning Acting and Planning [<sup>7</sup>](https://arxiv.org/abs/2310.04406)
5. LangGraph Documentation [<sup>1</sup>](https://langchain-ai.github.io/langgraph/)

---

_æœ¬æ–‡åŸºäº LangGraph å®˜æ–¹æ–‡æ¡£ç¼–å†™ï¼Œå¦‚æœ‰æ›´æ–°è¯·ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†ã€‚_

_æœ€åæ›´æ–°ï¼š2025-01-25_
